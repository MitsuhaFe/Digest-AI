# Digest AI 开发笔记

## 项目结构说明

### 核心文件

#### manifest.json
Chrome 扩展的配置文件，定义了：
- 扩展的基本信息（名称、版本、描述）
- 所需权限（storage、activeTab、scripting）
- 后台脚本和内容脚本的配置
- 图标和 popup 配置

#### popup.html/js/css
点击扩展图标时弹出的小窗口：
- 提供保存文章的入口
- 显示保存状态（空闲/处理中/成功/错误）
- 支持添加标签
- 检查配置状态

#### dashboard.html/js/css
阅读库主界面：
- 左侧：文章列表，支持搜索和筛选
- 右侧：文章详情（三段式视图）
- 提供文章管理功能（删除、标签）

#### settings.html/js/css
设置页面：
- 基本设置（主题、字体大小）
- AI 模型配置（选择模型、输入 API Key）
- 关于页面

### 核心脚本

#### scripts/background.js
后台服务工作进程（Service Worker）：
- 处理扩展的核心逻辑
- 接收和路由消息
- 调用 AI API
- 管理本地存储

**主要功能**：
- `handleSaveArticle()`: 处理文章保存流程
- `createAIAdapter()`: 创建对应的 AI 适配器
- 消息监听器：处理来自 popup 和 dashboard 的请求

#### scripts/content.js
内容脚本，注入到网页中：
- 提取网页的文章内容
- 使用 Readability 算法
- 提供备用提取方法

#### scripts/models/
AI 模型适配器：
- `adapter.js`: 基类，定义通用接口
- `gemini.js`: Google Gemini 适配器
- `openai.js`: OpenAI GPT 适配器
- `deepseek.js`: DeepSeek 适配器

每个适配器实现：
- `getEndpoint()`: API 端点
- `buildRequestBody()`: 构建请求
- `parseResponse()`: 解析响应
- `generateSummary()`: 主要调用方法

## 数据流

### 保存文章流程

```
用户点击保存
  ↓
popup.js 发送消息到 background.js
  ↓
background.js 向 content.js 请求提取内容
  ↓
content.js 使用 Readability 提取并返回
  ↓
background.js 调用 AI 适配器生成摘要
  ↓
AI API 返回摘要和核心观点
  ↓
background.js 保存到 chrome.storage.local
  ↓
返回成功结果到 popup.js
  ↓
popup.js 显示成功状态
```

### 消息通信

扩展使用 Chrome 消息传递 API：

```javascript
// 发送消息
chrome.runtime.sendMessage({
  action: 'saveArticle',
  data: {...}
}, (response) => {
  // 处理响应
});

// 监听消息
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'saveArticle') {
    // 处理请求
    sendResponse({ success: true });
  }
  return true; // 保持通道开启
});
```

## 技术要点

### Manifest V3 特性

- **Service Worker**: 替代传统的 background page
- **Promises**: 大部分 API 支持 Promise
- **权限最小化**: 只请求必要的权限
- **内容安全策略**: 严格的 CSP 防止 XSS

### 本地存储结构

```javascript
{
  articles: [
    {
      id: "unique-id",
      title: "文章标题",
      url: "https://...",
      source: "example.com",
      dateAdded: "2025-10-21T...",
      content: "纯文本内容",
      htmlContent: "HTML 内容",
      summary: "AI 摘要",
      keyPoints: ["观点1", "观点2"],
      tags: ["标签1", "标签2"]
    }
  ],
  settings: {
    aiModel: "gemini",
    apiKey: "...",
    theme: "light",
    fontSize: "medium"
  }
}
```

### AI 提示词设计

当前使用的提示词：

```
请分析以下文章内容，生成一个简洁的中文摘要（3-5句话）和3-5个核心观点。

请按照以下 JSON 格式返回结果：
{
  "summary": "文章摘要内容...",
  "keyPoints": [
    "核心观点1",
    "核心观点2",
    "核心观点3"
  ]
}

文章内容：
[文章正文...]

请直接返回 JSON 格式的结果，不要包含其他文字。
```

## 已知限制

### 当前版本（MVP）

1. **内容提取**
   - 部分网站的动态内容无法提取
   - 对某些复杂布局的网站效果不佳
   - 未来可以针对常见网站做特殊优化

2. **数据存储**
   - 仅本地存储，无跨设备同步
   - 存储空间受 Chrome 限制（约 10MB）
   - 未来版本将引入云同步

3. **AI 功能**
   - 依赖用户自己的 API Key
   - 没有本地缓存机制
   - 摘要质量取决于 AI 模型

4. **用户体验**
   - 图标使用占位符
   - 没有暗色主题实现
   - 字体大小设置未生效

## 待优化项

### 近期（V1.0）

- [ ] 实现真正的 Readability.js 集成（目前是简化版）
- [ ] 添加多个 AI 模型适配器（Claude、通义千问）
- [ ] 优化 AI 提示词，提高摘要质量
- [ ] 实现暗色主题
- [ ] 添加字体大小调整功能
- [ ] 改进错误处理和用户提示
- [ ] 添加加载动画和进度指示

### 中期（V2.0）

- [ ] 云同步功能
- [ ] AI 自动标签建议
- [ ] 划词高亮和笔记
- [ ] 自定义 AI 提示词
- [ ] 分享功能
- [ ] 导出功能（Markdown、PDF）

### 长期

- [ ] Firefox 和 Edge 支持
- [ ] 移动端支持
- [ ] 团队协作功能
- [ ] 知识图谱可视化

## 调试技巧

### 常用调试命令

```javascript
// 查看所有存储的文章
chrome.storage.local.get(['articles'], (result) => {
  console.log(result.articles);
});

// 清空所有数据
chrome.storage.local.clear();

// 查看设置
chrome.storage.local.get(['aiModel', 'apiKey'], (result) => {
  console.log(result);
});
```

### 测试建议

1. **测试不同类型的网站**：
   - 技术博客（如 Medium、Dev.to）
   - 新闻网站
   - 学术文章
   - 长篇文档

2. **测试边界情况**：
   - 非常短的文章
   - 非常长的文章
   - 包含大量图片的文章
   - 包含代码块的技术文章

3. **测试错误场景**：
   - 无效的 API Key
   - 网络断开
   - API 限流

## 性能考虑

1. **避免频繁的存储操作**
   - 批量更新而不是逐个更新

2. **优化 AI API 调用**
   - 考虑添加本地缓存
   - 实现请求去重
   - 添加重试机制

3. **优化渲染**
   - 大量文章时使用虚拟滚动
   - 懒加载文章内容

## 安全考虑

1. **API Key 安全**
   - 使用 chrome.storage.local（不同步）
   - 永远不要记录 API Key
   - 提供清除数据的选项

2. **内容安全**
   - 清理 HTML 内容，防止 XSS
   - 使用严格的 CSP

3. **权限最小化**
   - 只请求必要的权限
   - 明确说明权限用途

---

**最后更新**: 2025-10-21

