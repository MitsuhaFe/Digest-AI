{"version":3,"file":"background.js","mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://digest-ai-extension/./scripts/background.js"],"sourcesContent":["/**\n * Background Service Worker\n * å¤„ç†æ¶ˆæ¯è·¯ç”±ã€AI API è°ƒç”¨å’Œæ•°æ®ç®¡ç†\n */\n\n// ============================================\n// AI æ¨¡å‹é€‚é…å™¨ç±»ï¼ˆç›´æ¥åŒ…å«åœ¨æ­¤æ–‡ä»¶ä¸­ï¼‰\n// ============================================\n\n/**\n * é»˜è®¤æç¤ºè¯æ¨¡æ¿\n */\nconst DEFAULT_PROMPT_TEMPLATE = `è¯·åˆ†æä»¥ä¸‹æ–‡ç« å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªçº¦ {{SUMMARY_LENGTH}} å­—çš„ç®€æ´ä¸­æ–‡æ‘˜è¦ã€{{TAG_COUNT}} ä¸ªæ ¸å¿ƒè§‚ç‚¹å’Œ {{TAG_COUNT}} ä¸ªç›¸å…³æ ‡ç­¾ã€‚\n\nè¯·æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ç»“æœï¼š\n{\n  \"summary\": \"æ–‡ç« æ‘˜è¦å†…å®¹...\",\n  \"keyPoints\": [\n    \"æ ¸å¿ƒè§‚ç‚¹1\",\n    \"æ ¸å¿ƒè§‚ç‚¹2\",\n    \"æ ¸å¿ƒè§‚ç‚¹3\"\n  ],\n  \"tags\": [\n    \"æ ‡ç­¾1\",\n    \"æ ‡ç­¾2\",\n    \"æ ‡ç­¾3\"\n  ]\n}\n\næ–‡ç« å†…å®¹ï¼š\n{{TEXT}}\n\nè¯·ç›´æ¥è¿”å› JSON æ ¼å¼çš„ç»“æœï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ã€‚`;\n\n/**\n * Google Gemini æ¨¡å‹é€‚é…å™¨\n */\nclass GeminiAdapter {\n  constructor(apiKey, config = {}) {\n    this.apiKey = apiKey;\n    this.modelName = 'gemini-2.5-flash';\n    this.config = {\n      summaryLength: config.summaryLength || 200,\n      tagCount: config.tagCount || 3,\n      enableAutoTags: config.enableAutoTags !== false,\n      customPrompt: config.customPrompt || null,\n      enableCustomPrompt: config.enableCustomPrompt || false\n    };\n  }\n  \n  getEndpoint() {\n    return `https://generativelanguage.googleapis.com/v1beta/models/${this.modelName}:generateContent?key=${this.apiKey}`;\n  }\n  \n  getHeaders() {\n    return {\n      'Content-Type': 'application/json'\n    };\n  }\n  \n  generatePrompt(text) {\n    // ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯æˆ–é»˜è®¤æç¤ºè¯\n    const template = this.config.enableCustomPrompt && this.config.customPrompt \n      ? this.config.customPrompt \n      : DEFAULT_PROMPT_TEMPLATE;\n    \n    // æ›¿æ¢æ¨¡æ¿å˜é‡\n    return template\n      .replace(/\\{\\{TEXT\\}\\}/g, text.substring(0, 8000))\n      .replace(/\\{\\{SUMMARY_LENGTH\\}\\}/g, this.config.summaryLength)\n      .replace(/\\{\\{TAG_COUNT\\}\\}/g, this.config.tagCount);\n  }\n  \n  buildRequestBody(text) {\n    const prompt = this.generatePrompt(text);\n    \n    return {\n      contents: [{\n        parts: [{\n          text: prompt\n        }]\n      }],\n      generationConfig: {\n        temperature: 0.4,\n        topK: 32,\n        topP: 1,\n        maxOutputTokens: 8192  // å¢åŠ åˆ°8192ä»¥å®¹çº³æ€è€ƒè¿‡ç¨‹å’Œå®é™…å“åº”\n      }\n    };\n  }\n  \n  parseResponse(data) {\n    try {\n      // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—\n      console.log('ğŸ” Gemini API åŸå§‹å“åº”:', JSON.stringify(data, null, 2));\n      \n      if (!data.candidates || data.candidates.length === 0) {\n        console.error('âŒ æ²¡æœ‰å€™é€‰ç»“æœ:', data);\n        throw new Error('API è¿”å›äº†ç©ºç»“æœ');\n      }\n      \n      const candidate = data.candidates[0];\n      console.log('ğŸ” å€™é€‰ç»“æœå®Œæ•´ç»“æ„:', candidate);\n      console.log('ğŸ” å€™é€‰ç»“æœçš„æ‰€æœ‰é”®:', Object.keys(candidate));\n      if (candidate.content) {\n        console.log('ğŸ” content å†…å®¹:', candidate.content);\n        console.log('ğŸ” content çš„é”®:', Object.keys(candidate.content));\n      }\n      \n      // æ£€æŸ¥æ–°æ ¼å¼ï¼šå¯èƒ½æ˜¯ candidate.content.parts æˆ–è€…å…¶ä»–ç»“æ„\n      let text = '';\n      \n      // å°è¯•å¤šç§å¯èƒ½çš„å“åº”æ ¼å¼\n      \n      // 1. æ ‡å‡†æ ¼å¼ï¼šcandidate.content.parts[].text\n      if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {\n        console.log('ğŸ” æ‰¾åˆ° parts æ•°ç»„ï¼Œé•¿åº¦:', candidate.content.parts.length);\n        // Gemini 2.5 å¯èƒ½æœ‰å¤šä¸ª partsï¼ŒåŒ…æ‹¬ thought å’Œå®é™…å“åº”\n        // å°è¯•æ‰¾åˆ°åŒ…å« text çš„ part\n        for (let i = 0; i < candidate.content.parts.length; i++) {\n          const part = candidate.content.parts[i];\n          console.log(`ğŸ” æ£€æŸ¥ part[${i}]:`, part);\n          if (part.text) {\n            text = part.text;\n            console.log(`âœ… åœ¨ parts[${i}] ä¸­æ‰¾åˆ°æ–‡æœ¬:`, text.substring(0, 100));\n            break;\n          }\n        }\n      }\n      \n      // 2. ç›´æ¥æ–‡æœ¬å­—æ®µ\n      if (!text && candidate.text) {\n        text = candidate.text;\n        console.log('âœ… ä½¿ç”¨ç›´æ¥æ–‡æœ¬æ ¼å¼');\n      }\n      \n      // 3. Message æ ¼å¼\n      if (!text && candidate.message && candidate.message.content) {\n        text = candidate.message.content;\n        console.log('âœ… ä½¿ç”¨æ¶ˆæ¯æ ¼å¼');\n      }\n      \n      // 4. Output å­—æ®µ (æŸäº›æ¨¡å‹å¯èƒ½ä½¿ç”¨)\n      if (!text && candidate.output) {\n        text = candidate.output;\n        console.log('âœ… ä½¿ç”¨ output å­—æ®µ');\n      }\n      \n      // 5. æ£€æŸ¥æ˜¯å¦æœ‰ thoughts å’Œ response åˆ†ç¦»çš„æƒ…å†µ\n      if (!text && candidate.content) {\n        // å¯èƒ½æ•´ä¸ª content å°±æ˜¯æ–‡æœ¬\n        if (typeof candidate.content === 'string') {\n          text = candidate.content;\n          console.log('âœ… content æœ¬èº«æ˜¯å­—ç¬¦ä¸²');\n        }\n      }\n      \n      if (!text) {\n        console.error('âŒ æ— æ³•æ‰¾åˆ°æ–‡æœ¬å†…å®¹');\n        console.error('å€™é€‰å®Œæ•´å¯¹è±¡:', JSON.stringify(candidate, null, 2));\n        throw new Error('API è¿”å›æ ¼å¼é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°æ–‡æœ¬å†…å®¹ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚');\n      }\n      \n      console.log('ğŸ“ æå–çš„æ–‡æœ¬:', text);\n      \n      if (!text) {\n        throw new Error('API è¿”å›çš„æ–‡æœ¬å†…å®¹ä¸ºç©º');\n      }\n      \n      const result = this.extractJSON(text);\n      console.log('ğŸ“Š è§£æçš„JSONç»“æœ:', result);\n      \n      return {\n        summary: result.summary || '',\n        keyPoints: result.keyPoints || [],\n        suggestedTags: this.config.enableAutoTags ? (result.tags || []) : []\n      };\n    } catch (error) {\n      console.error('âŒ è§£æ Gemini å“åº”å¤±è´¥:', error);\n      console.error('âŒ åŸå§‹æ•°æ®:', data);\n      throw new Error('è§£æ AI å“åº”å¤±è´¥: ' + error.message);\n    }\n  }\n  \n  extractJSON(text) {\n    try {\n      return JSON.parse(text);\n    } catch (e) {\n      const jsonMatch = text.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[1]);\n      }\n      \n      const braceMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (braceMatch) {\n        return JSON.parse(braceMatch[0]);\n      }\n      \n      throw new Error('æ— æ³•ä»å“åº”ä¸­æå– JSON');\n    }\n  }\n  \n  async generateSummary(text) {\n    const endpoint = this.getEndpoint();\n    const requestBody = this.buildRequestBody(text);\n    const headers = this.getHeaders();\n    \n    try {\n      const response = await fetch(endpoint, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(requestBody)\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(`Gemini API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || response.statusText}`);\n      }\n      \n      const data = await response.json();\n      return this.parseResponse(data);\n    } catch (error) {\n      console.error('Gemini API è°ƒç”¨å¤±è´¥:', error);\n      throw error;\n    }\n  }\n}\n\n/**\n * OpenAI GPT æ¨¡å‹é€‚é…å™¨\n */\nclass OpenAIAdapter {\n  constructor(apiKey, config = {}) {\n    this.apiKey = apiKey;\n    this.modelName = 'gpt-3.5-turbo';\n    this.config = {\n      summaryLength: config.summaryLength || 200,\n      tagCount: config.tagCount || 3,\n      enableAutoTags: config.enableAutoTags !== false,\n      customPrompt: config.customPrompt || null,\n      enableCustomPrompt: config.enableCustomPrompt || false\n    };\n  }\n  \n  getEndpoint() {\n    return 'https://api.openai.com/v1/chat/completions';\n  }\n  \n  getHeaders() {\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${this.apiKey}`\n    };\n  }\n  \n  generatePrompt(text) {\n    const template = this.config.enableCustomPrompt && this.config.customPrompt \n      ? this.config.customPrompt \n      : DEFAULT_PROMPT_TEMPLATE;\n    \n    return template\n      .replace(/\\{\\{TEXT\\}\\}/g, text.substring(0, 8000))\n      .replace(/\\{\\{SUMMARY_LENGTH\\}\\}/g, this.config.summaryLength)\n      .replace(/\\{\\{TAG_COUNT\\}\\}/g, this.config.tagCount);\n  }\n  \n  buildRequestBody(text) {\n    const prompt = this.generatePrompt(text);\n    \n    const systemPrompt = this.config.enableAutoTags\n      ? 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ï¼Œå¹¶èƒ½æ¨èç›¸å…³æ ‡ç­¾ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚'\n      : 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚';\n    \n    return {\n      model: this.modelName,\n      messages: [\n        {\n          role: 'system',\n          content: systemPrompt\n        },\n        {\n          role: 'user',\n          content: prompt\n        }\n      ],\n      temperature: 0.4,\n      max_tokens: 1024,\n      response_format: { type: 'json_object' }\n    };\n  }\n  \n  parseResponse(data) {\n    try {\n      if (!data.choices || data.choices.length === 0) {\n        throw new Error('API è¿”å›äº†ç©ºç»“æœ');\n      }\n      \n      const choice = data.choices[0];\n      if (!choice.message || !choice.message.content) {\n        throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');\n      }\n      \n      const result = JSON.parse(choice.message.content);\n      \n      return {\n        summary: result.summary || '',\n        keyPoints: result.keyPoints || [],\n        suggestedTags: this.config.enableAutoTags ? (result.tags || []) : []\n      };\n    } catch (error) {\n      console.error('è§£æ OpenAI å“åº”å¤±è´¥:', error);\n      throw new Error('è§£æ AI å“åº”å¤±è´¥: ' + error.message);\n    }\n  }\n  \n  async generateSummary(text) {\n    const endpoint = this.getEndpoint();\n    const requestBody = this.buildRequestBody(text);\n    const headers = this.getHeaders();\n    \n    try {\n      const response = await fetch(endpoint, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(requestBody)\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(`OpenAI API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || response.statusText}`);\n      }\n      \n      const data = await response.json();\n      return this.parseResponse(data);\n    } catch (error) {\n      console.error('OpenAI API è°ƒç”¨å¤±è´¥:', error);\n      throw error;\n    }\n  }\n}\n\n/**\n * Anthropic Claude æ¨¡å‹é€‚é…å™¨\n */\nclass ClaudeAdapter {\n  constructor(apiKey, config = {}) {\n    this.apiKey = apiKey;\n    this.modelName = 'claude-3-haiku-20240307';\n    this.config = {\n      summaryLength: config.summaryLength || 200,\n      tagCount: config.tagCount || 3,\n      enableAutoTags: config.enableAutoTags !== false,\n      customPrompt: config.customPrompt || null,\n      enableCustomPrompt: config.enableCustomPrompt || false\n    };\n  }\n  \n  getEndpoint() {\n    return 'https://api.anthropic.com/v1/messages';\n  }\n  \n  getHeaders() {\n    return {\n      'Content-Type': 'application/json',\n      'x-api-key': this.apiKey,\n      'anthropic-version': '2023-06-01'\n    };\n  }\n  \n  generatePrompt(text) {\n    const template = this.config.enableCustomPrompt && this.config.customPrompt \n      ? this.config.customPrompt \n      : DEFAULT_PROMPT_TEMPLATE;\n    \n    return template\n      .replace(/\\{\\{TEXT\\}\\}/g, text.substring(0, 8000))\n      .replace(/\\{\\{SUMMARY_LENGTH\\}\\}/g, this.config.summaryLength)\n      .replace(/\\{\\{TAG_COUNT\\}\\}/g, this.config.tagCount);\n  }\n  \n  buildRequestBody(text) {\n    const prompt = this.generatePrompt(text);\n    \n    return {\n      model: this.modelName,\n      max_tokens: 1024,\n      temperature: 0.4,\n      messages: [\n        {\n          role: 'user',\n          content: prompt\n        }\n      ]\n    };\n  }\n  \n  parseResponse(data) {\n    try {\n      if (!data.content || data.content.length === 0) {\n        throw new Error('API è¿”å›äº†ç©ºç»“æœ');\n      }\n      \n      const content = data.content[0];\n      if (!content.text) {\n        throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');\n      }\n      \n      const text = content.text;\n      const result = this.extractJSON(text);\n      \n      return {\n        summary: result.summary || '',\n        keyPoints: result.keyPoints || [],\n        suggestedTags: this.config.enableAutoTags ? (result.tags || []) : []\n      };\n    } catch (error) {\n      console.error('è§£æ Claude å“åº”å¤±è´¥:', error);\n      throw new Error('è§£æ AI å“åº”å¤±è´¥: ' + error.message);\n    }\n  }\n  \n  extractJSON(text) {\n    try {\n      return JSON.parse(text);\n    } catch (e) {\n      const jsonMatch = text.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[1]);\n      }\n      \n      const braceMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (braceMatch) {\n        return JSON.parse(braceMatch[0]);\n      }\n      \n      throw new Error('æ— æ³•ä»å“åº”ä¸­æå– JSON');\n    }\n  }\n  \n  async generateSummary(text) {\n    const endpoint = this.getEndpoint();\n    const requestBody = this.buildRequestBody(text);\n    const headers = this.getHeaders();\n    \n    try {\n      const response = await fetch(endpoint, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(requestBody)\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(`Claude API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || response.statusText}`);\n      }\n      \n      const data = await response.json();\n      return this.parseResponse(data);\n    } catch (error) {\n      console.error('Claude API è°ƒç”¨å¤±è´¥:', error);\n      throw error;\n    }\n  }\n}\n\n/**\n * é€šä¹‰åƒé—®æ¨¡å‹é€‚é…å™¨\n */\nclass QwenAdapter {\n  constructor(apiKey, config = {}) {\n    this.apiKey = apiKey;\n    this.modelName = 'qwen-plus';\n    this.config = {\n      summaryLength: config.summaryLength || 200,\n      tagCount: config.tagCount || 3,\n      enableAutoTags: config.enableAutoTags !== false,\n      customPrompt: config.customPrompt || null,\n      enableCustomPrompt: config.enableCustomPrompt || false\n    };\n  }\n  \n  getEndpoint() {\n    return 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation';\n  }\n  \n  getHeaders() {\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${this.apiKey}`\n    };\n  }\n  \n  generatePrompt(text) {\n    const template = this.config.enableCustomPrompt && this.config.customPrompt \n      ? this.config.customPrompt \n      : DEFAULT_PROMPT_TEMPLATE;\n    \n    return template\n      .replace(/\\{\\{TEXT\\}\\}/g, text.substring(0, 8000))\n      .replace(/\\{\\{SUMMARY_LENGTH\\}\\}/g, this.config.summaryLength)\n      .replace(/\\{\\{TAG_COUNT\\}\\}/g, this.config.tagCount);\n  }\n  \n  buildRequestBody(text) {\n    const prompt = this.generatePrompt(text);\n    \n    const systemPrompt = this.config.enableAutoTags\n      ? 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ï¼Œå¹¶èƒ½æ¨èç›¸å…³æ ‡ç­¾ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚'\n      : 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚';\n    \n    return {\n      model: this.modelName,\n      input: {\n        messages: [\n          {\n            role: 'system',\n            content: systemPrompt\n          },\n          {\n            role: 'user',\n            content: prompt\n          }\n        ]\n      },\n      parameters: {\n        temperature: 0.4,\n        max_tokens: 1024,\n        result_format: 'message'\n      }\n    };\n  }\n  \n  parseResponse(data) {\n    try {\n      if (!data.output || !data.output.choices || data.output.choices.length === 0) {\n        throw new Error('API è¿”å›äº†ç©ºç»“æœ');\n      }\n      \n      const choice = data.output.choices[0];\n      if (!choice.message || !choice.message.content) {\n        throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');\n      }\n      \n      const text = choice.message.content;\n      const result = this.extractJSON(text);\n      \n      return {\n        summary: result.summary || '',\n        keyPoints: result.keyPoints || [],\n        suggestedTags: this.config.enableAutoTags ? (result.tags || []) : []\n      };\n    } catch (error) {\n      console.error('è§£æé€šä¹‰åƒé—®å“åº”å¤±è´¥:', error);\n      throw new Error('è§£æ AI å“åº”å¤±è´¥: ' + error.message);\n    }\n  }\n  \n  extractJSON(text) {\n    try {\n      return JSON.parse(text);\n    } catch (e) {\n      const jsonMatch = text.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[1]);\n      }\n      \n      const braceMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (braceMatch) {\n        return JSON.parse(braceMatch[0]);\n      }\n      \n      throw new Error('æ— æ³•ä»å“åº”ä¸­æå– JSON');\n    }\n  }\n  \n  async generateSummary(text) {\n    const endpoint = this.getEndpoint();\n    const requestBody = this.buildRequestBody(text);\n    const headers = this.getHeaders();\n    \n    try {\n      const response = await fetch(endpoint, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(requestBody)\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(`é€šä¹‰åƒé—® API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.message || response.statusText}`);\n      }\n      \n      const data = await response.json();\n      return this.parseResponse(data);\n    } catch (error) {\n      console.error('é€šä¹‰åƒé—® API è°ƒç”¨å¤±è´¥:', error);\n      throw error;\n    }\n  }\n}\n\n/**\n * DeepSeek æ¨¡å‹é€‚é…å™¨\n */\nclass DeepSeekAdapter {\n  constructor(apiKey, config = {}) {\n    this.apiKey = apiKey;\n    this.modelName = 'deepseek-chat';\n    this.config = {\n      summaryLength: config.summaryLength || 200,\n      tagCount: config.tagCount || 3,\n      enableAutoTags: config.enableAutoTags !== false,\n      customPrompt: config.customPrompt || null,\n      enableCustomPrompt: config.enableCustomPrompt || false\n    };\n  }\n  \n  getEndpoint() {\n    return 'https://api.deepseek.com/v1/chat/completions';\n  }\n  \n  getHeaders() {\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${this.apiKey}`\n    };\n  }\n  \n  generatePrompt(text) {\n    const template = this.config.enableCustomPrompt && this.config.customPrompt \n      ? this.config.customPrompt \n      : DEFAULT_PROMPT_TEMPLATE;\n    \n    return template\n      .replace(/\\{\\{TEXT\\}\\}/g, text.substring(0, 8000))\n      .replace(/\\{\\{SUMMARY_LENGTH\\}\\}/g, this.config.summaryLength)\n      .replace(/\\{\\{TAG_COUNT\\}\\}/g, this.config.tagCount);\n  }\n  \n  buildRequestBody(text) {\n    const prompt = this.generatePrompt(text);\n    \n    const systemPrompt = this.config.enableAutoTags\n      ? 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ï¼Œå¹¶èƒ½æ¨èç›¸å…³æ ‡ç­¾ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚'\n      : 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚';\n    \n    return {\n      model: this.modelName,\n      messages: [\n        {\n          role: 'system',\n          content: systemPrompt\n        },\n        {\n          role: 'user',\n          content: prompt\n        }\n      ],\n      temperature: 0.4,\n      max_tokens: 1024\n    };\n  }\n  \n  parseResponse(data) {\n    try {\n      if (!data.choices || data.choices.length === 0) {\n        throw new Error('API è¿”å›äº†ç©ºç»“æœ');\n      }\n      \n      const choice = data.choices[0];\n      if (!choice.message || !choice.message.content) {\n        throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');\n      }\n      \n      const text = choice.message.content;\n      const result = this.extractJSON(text);\n      \n      return {\n        summary: result.summary || '',\n        keyPoints: result.keyPoints || [],\n        suggestedTags: this.config.enableAutoTags ? (result.tags || []) : []\n      };\n    } catch (error) {\n      console.error('è§£æ DeepSeek å“åº”å¤±è´¥:', error);\n      throw new Error('è§£æ AI å“åº”å¤±è´¥: ' + error.message);\n    }\n  }\n  \n  extractJSON(text) {\n    try {\n      return JSON.parse(text);\n    } catch (e) {\n      const jsonMatch = text.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[1]);\n      }\n      \n      const braceMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (braceMatch) {\n        return JSON.parse(braceMatch[0]);\n      }\n      \n      throw new Error('æ— æ³•ä»å“åº”ä¸­æå– JSON');\n    }\n  }\n  \n  async generateSummary(text) {\n    const endpoint = this.getEndpoint();\n    const requestBody = this.buildRequestBody(text);\n    const headers = this.getHeaders();\n    \n    try {\n      const response = await fetch(endpoint, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify(requestBody)\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(`DeepSeek API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || response.statusText}`);\n      }\n      \n      const data = await response.json();\n      return this.parseResponse(data);\n    } catch (error) {\n      console.error('DeepSeek API è°ƒç”¨å¤±è´¥:', error);\n      throw error;\n    }\n  }\n}\n\n// ============================================\n// é€‚é…å™¨å·¥å‚å‡½æ•°\n// ============================================\n\n/**\n * åˆ›å»º AI é€‚é…å™¨å·¥å‚\n */\nfunction createAIAdapter(modelType, apiKey, config = {}) {\n  switch (modelType) {\n    case 'gemini':\n      return new GeminiAdapter(apiKey, config);\n    case 'openai':\n      return new OpenAIAdapter(apiKey, config);\n    case 'claude':\n      return new ClaudeAdapter(apiKey, config);\n    case 'deepseek':\n      return new DeepSeekAdapter(apiKey, config);\n    case 'qwen':\n      return new QwenAdapter(apiKey, config);\n    default:\n      throw new Error(`ä¸æ”¯æŒçš„æ¨¡å‹ç±»å‹: ${modelType}`);\n  }\n}\n\n/**\n * ç”Ÿæˆå”¯ä¸€ ID\n */\nfunction generateId() {\n  return Date.now().toString(36) + Math.random().toString(36).substr(2);\n}\n\n/**\n * è·å–å­˜å‚¨çš„æ–‡ç« åˆ—è¡¨\n */\nasync function getArticles() {\n  try {\n    const result = await chrome.storage.local.get(['articles']);\n    return result.articles || [];\n  } catch (error) {\n    console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);\n    return [];\n  }\n}\n\n/**\n * ä¿å­˜æ–‡ç« åˆ°å­˜å‚¨\n */\nasync function saveArticleToStorage(article) {\n  try {\n    const articles = await getArticles();\n    articles.unshift(article); // æ–°æ–‡ç« æ·»åŠ åˆ°å¼€å¤´\n    \n    await chrome.storage.local.set({ articles });\n    return true;\n  } catch (error) {\n    console.error('ä¿å­˜æ–‡ç« å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * æ›´æ–°æ–‡ç« æ ‡ç­¾\n */\nasync function updateArticleTags(articleId, tags) {\n  try {\n    const articles = await getArticles();\n    const article = articles.find(a => a.id === articleId);\n    \n    if (article) {\n      article.tags = tags;\n      await chrome.storage.local.set({ articles });\n      return true;\n    }\n    \n    return false;\n  } catch (error) {\n    console.error('æ›´æ–°æ–‡ç« æ ‡ç­¾å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * å¤„ç†ä¿å­˜æ–‡ç« è¯·æ±‚\n */\nasync function handleSaveArticle(tabId, url, title, saveOriginalContent, saveImages) {\n  try {\n    // 1. ä» content script æå–å†…å®¹\n    const contentResponse = await chrome.tabs.sendMessage(tabId, {\n      action: 'extractContent'\n    });\n    \n    if (!contentResponse.success) {\n      throw new Error(contentResponse.error || 'æå–å†…å®¹å¤±è´¥');\n    }\n    \n    const extractedContent = contentResponse.content;\n    \n    // 2. è·å–ç”¨æˆ·è®¾ç½®\n    const settings = await chrome.storage.local.get([\n      'aiModel',\n      // æ—§ç‰ˆæœ¬çš„å•ä¸€ apiKeyï¼ˆç”¨äºå‘åå…¼å®¹ï¼‰\n      'apiKey',\n      // æ–°ç‰ˆæœ¬çš„å¤šæ¨¡å‹ API Keys\n      'geminiApiKey',\n      'openaiApiKey',\n      'claudeApiKey',\n      'deepseekApiKey',\n      'qwenApiKey',\n      'summaryLength',\n      'tagCount',\n      'enableAutoTags',\n      'enableCustomPrompt',\n      'customPrompt',\n      'saveOriginalContent',\n      'saveImages'\n    ]);\n    \n    // ä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œå¦‚æœæœªæä¾›åˆ™ä½¿ç”¨è®¾ç½®ä¸­çš„é»˜è®¤å€¼\n    const shouldSaveOriginal = saveOriginalContent !== undefined ? saveOriginalContent : (settings.saveOriginalContent !== undefined ? settings.saveOriginalContent : true);\n    const shouldSaveImages = saveImages !== undefined ? saveImages : (settings.saveImages !== undefined ? settings.saveImages : true);\n    \n    console.log('æœ€ç»ˆä¿å­˜é€‰é¡¹ - åŸæ–‡:', shouldSaveOriginal, 'å›¾ç‰‡:', shouldSaveImages);\n    \n    if (!settings.aiModel) {\n      throw new Error('æœªé…ç½® AI æ¨¡å‹');\n    }\n    \n    // æ ¹æ®é€‰æ‹©çš„æ¨¡å‹è·å–å¯¹åº”çš„ API Key\n    const apiKeyMap = {\n      'gemini': settings.geminiApiKey,\n      'openai': settings.openaiApiKey,\n      'claude': settings.claudeApiKey,\n      'deepseek': settings.deepseekApiKey,\n      'qwen': settings.qwenApiKey\n    };\n    \n    let apiKey = apiKeyMap[settings.aiModel];\n    \n    // å‘åå…¼å®¹ï¼šå¦‚æœæ–° key ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨æ—§çš„ apiKey\n    if (!apiKey && settings.apiKey) {\n      apiKey = settings.apiKey;\n      console.log('ä½¿ç”¨æ—§ç‰ˆ API Keyï¼ˆå‘åå…¼å®¹ï¼‰');\n    }\n    \n    if (!apiKey) {\n      const modelNames = {\n        'gemini': 'Google Gemini',\n        'openai': 'OpenAI',\n        'claude': 'Anthropic Claude',\n        'deepseek': 'DeepSeek',\n        'qwen': 'é€šä¹‰åƒé—®'\n      };\n      throw new Error(`æœªé…ç½® ${modelNames[settings.aiModel] || settings.aiModel} çš„ API Keyï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢é…ç½®`);\n    }\n    \n    // 3. æ„å»ºé€‚é…å™¨é…ç½®\n    const adapterConfig = {\n      summaryLength: settings.summaryLength || 200,\n      tagCount: settings.tagCount || 3,\n      enableAutoTags: settings.enableAutoTags !== false,\n      enableCustomPrompt: settings.enableCustomPrompt || false,\n      customPrompt: settings.customPrompt || null\n    };\n    \n    // 4. æ£€æµ‹å†…å®¹ç±»å‹\n    const contentType = extractedContent.type || 'webpage';\n    const isVideo = contentType.startsWith('video-');\n    \n    console.log('å†…å®¹ç±»å‹:', contentType);\n    \n    // 5. å¤„ç†å›¾ç‰‡å’ŒåŸæ–‡ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©å’Œå†…å®¹ç±»å‹ï¼‰\n    let htmlContent = extractedContent.htmlContent || '';\n    let textContent = extractedContent.content || '';\n    \n    // å¯¹äºéè§†é¢‘å†…å®¹ï¼ŒæŒ‰ç…§åŸæœ‰é€»è¾‘å¤„ç†\n    if (!isVideo) {\n      console.log('åŸå§‹HTMLé•¿åº¦:', htmlContent.length);\n      \n      if (!shouldSaveImages && htmlContent) {\n        // ç§»é™¤æ‰€æœ‰å›¾ç‰‡æ ‡ç­¾\n        htmlContent = htmlContent.replace(/<img[^>]*>/gi, '');\n        // ç§»é™¤åŒ…å«å›¾ç‰‡çš„ figure æ ‡ç­¾\n        htmlContent = htmlContent.replace(/<figure[^>]*>.*?<\\/figure>/gi, '');\n        console.log('ç§»é™¤å›¾ç‰‡åHTMLé•¿åº¦:', htmlContent.length);\n      }\n      \n      if (!shouldSaveOriginal) {\n        // ä¸ä¿å­˜åŸæ–‡ï¼Œæ¸…ç©ºå†…å®¹\n        textContent = '';\n        htmlContent = '';\n        console.log('å·²æ¸…ç©ºåŸæ–‡å†…å®¹ï¼Œä»…ä¿å­˜æ‘˜è¦');\n      }\n    }\n    \n    // 6. è°ƒç”¨ AI ç”Ÿæˆæ‘˜è¦ã€æ ¸å¿ƒè§‚ç‚¹å’Œæ ‡ç­¾\n    const adapter = createAIAdapter(settings.aiModel, apiKey, adapterConfig);\n    const aiResult = await adapter.generateSummary(textContent);\n    \n    // 7. æ„å»ºæ–‡ç« /è§†é¢‘å¯¹è±¡\n    const article = {\n      id: generateId(),\n      type: contentType,\n      title: extractedContent.title || title,\n      url: url,\n      source: extractedContent.siteName || (extractedContent.videoInfo?.author) || new URL(url).hostname,\n      dateAdded: new Date().toISOString(),\n      content: textContent,\n      htmlContent: htmlContent,\n      excerpt: extractedContent.excerpt || '',\n      summary: aiResult.summary,\n      keyPoints: aiResult.keyPoints,\n      tags: [],\n      suggestedTags: aiResult.suggestedTags || [],\n      byline: extractedContent.byline || extractedContent.videoInfo?.author || '',\n      hasOriginalContent: shouldSaveOriginal\n    };\n    \n    // å¯¹äºè§†é¢‘å†…å®¹ï¼Œæ·»åŠ é¢å¤–çš„å…ƒæ•°æ®\n    if (isVideo) {\n      article.videoMetadata = {\n        duration: extractedContent.metadata?.duration || 0,\n        author: extractedContent.metadata?.author || '',\n        cover: extractedContent.metadata?.cover || '',\n        pubdate: extractedContent.metadata?.pubdate || '',\n        tags: extractedContent.metadata?.tags || [],\n        stats: extractedContent.metadata?.stats || {},\n        subtitles: extractedContent.subtitles || { available: false },\n        comments: extractedContent.comments || null\n      };\n      \n      // è§†é¢‘æè¿°ä½œä¸ºexcerpt\n      if (extractedContent.videoInfo?.description) {\n        article.excerpt = extractedContent.videoInfo.description.substring(0, 300);\n      }\n    }\n    \n    // 6. ä¿å­˜åˆ°å­˜å‚¨\n    await saveArticleToStorage(article);\n    \n    return {\n      success: true,\n      article: article\n    };\n  } catch (error) {\n    console.error('ä¿å­˜æ–‡ç« å¤±è´¥:', error);\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n}\n\n/**\n * æ¶ˆæ¯ç›‘å¬å™¨\n */\n// ç¡®ä¿ service worker ç«‹å³å“åº”æ¶ˆæ¯\nchrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n  console.log('ğŸ“¬ Background æ”¶åˆ°æ¶ˆæ¯:', request.action || request);\n  \n    // ä¿å­˜æ–‡ç« \n    if (request.action === 'saveArticle') {\n      // è·å– tabIdï¼šä¼˜å…ˆä» request è·å–ï¼ˆpopup å‘é€ï¼‰ï¼Œå…¶æ¬¡ä» sender è·å–ï¼ˆcontent script å‘é€ï¼‰\n      const tabId = request.tabId || sender.tab?.id;\n      \n      if (!tabId) {\n        console.error('æ— æ³•è·å– tabId');\n        sendResponse({ success: false, error: 'æ— æ³•è·å–æ ‡ç­¾é¡µID' });\n        return true;\n      }\n      \n      console.log('ä¿å­˜æ–‡ç« è¯·æ±‚ - æ¥æº:', sender.tab ? 'content script' : 'popup', 'tabId:', tabId, 'url:', request.url);\n      console.log('ä¿å­˜é€‰é¡¹ - åŸæ–‡:', request.saveOriginalContent, 'å›¾ç‰‡:', request.saveImages);\n      \n      handleSaveArticle(tabId, request.url, request.title, request.saveOriginalContent, request.saveImages)\n        .then(response => sendResponse(response))\n        .catch(error => sendResponse({ success: false, error: error.message }));\n    return true; // ä¿æŒæ¶ˆæ¯é€šé“å¼€å¯\n  }\n  \n  // æ›´æ–°æ–‡ç« æ ‡ç­¾\n  if (request.action === 'updateArticleTags') {\n    updateArticleTags(request.articleId, request.tags)\n      .then(() => sendResponse({ success: true }))\n      .catch(error => sendResponse({ success: false, error: error.message }));\n    return true;\n  }\n  \n  // è·å–æ‰€æœ‰æ–‡ç« \n  if (request.action === 'getArticles') {\n    getArticles()\n      .then(articles => sendResponse({ success: true, articles }))\n      .catch(error => sendResponse({ success: false, error: error.message }));\n    return true;\n  }\n  \n  // åˆ é™¤æ–‡ç« \n  if (request.action === 'deleteArticle') {\n    getArticles()\n      .then(async (articles) => {\n        const filtered = articles.filter(a => a.id !== request.articleId);\n        await chrome.storage.local.set({ articles: filtered });\n        sendResponse({ success: true });\n      })\n      .catch(error => sendResponse({ success: false, error: error.message }));\n    return true;\n  }\n  \n  return false;\n});\n\n/**\n * æ‰©å±•å®‰è£…æ—¶çš„åˆå§‹åŒ–\n */\nchrome.runtime.onInstalled.addListener((details) => {\n  if (details.reason === 'install') {\n    console.log('Digest AI å·²å®‰è£…');\n    \n    // æ‰“å¼€æ¬¢è¿é¡µé¢æˆ–è®¾ç½®é¡µé¢\n    chrome.tabs.create({ url: 'settings.html' });\n  } else if (details.reason === 'update') {\n    console.log('Digest AI å·²æ›´æ–°åˆ°ç‰ˆæœ¬:', chrome.runtime.getManifest().version);\n  }\n});\n\nconsole.log('Background service worker å·²å¯åŠ¨');\n\n"],"names":[],"sourceRoot":""}