(()=>{if(window.location.hostname.includes("bilibili.com")&&window.location.pathname.includes("/video/")){console.log("ğŸ¬ æ£€æµ‹åˆ° Bilibili è§†é¢‘é¡µé¢ï¼Œåˆå§‹åŒ–é€‚é…å™¨...");class t{constructor(){this.apiBase="https://api.bilibili.com"}extractVideoId(t){const e=t.match(/\/video\/(BV[a-zA-Z0-9]+)/);if(e)return{type:"bvid",id:e[1]};const n=t.match(/\/video\/av(\d+)/);return n?{type:"aid",id:n[1]}:null}extractVideoInfoFromPage(){try{const t=window.__INITIAL_STATE__;if(!t||!t.videoData)throw new Error("æ— æ³•ä»é¡µé¢è·å–è§†é¢‘ä¿¡æ¯");const e=t.videoData;return{title:e.title||document.title.replace(" - å“”å“©å“”å“©",""),description:e.desc||"",duration:e.duration||0,author:e.owner?.name||"",cover:e.pic||"",bvid:e.bvid||"",aid:e.aid||"",cid:e.cid||e.pages?.[0]?.cid||"",pubdate:e.pubdate?new Date(1e3*e.pubdate).toISOString():"",tags:(e.tag||[]).map(t=>t.tag_name||t),view:e.stat?.view||0,like:e.stat?.like||0,coin:e.stat?.coin||0}}catch(t){return console.error("æå–Bilibiliè§†é¢‘ä¿¡æ¯å¤±è´¥:",t),this.extractBasicInfoFromDOM()}}extractBasicInfoFromDOM(){const t=document.querySelector("h1.video-title")||document.querySelector(".video-title"),e=document.querySelector(".video-desc")||document.querySelector(".basic-desc-info"),n=document.querySelector(".up-name")||document.querySelector(".username");return{title:t?.textContent?.trim()||document.title.replace(" - å“”å“©å“”å“©",""),description:e?.textContent?.trim()||"",author:n?.textContent?.trim()||"",duration:0,cover:"",bvid:this.extractVideoId(window.location.href)?.id||"",aid:"",cid:"",pubdate:"",tags:[],view:0,like:0,coin:0}}async getSubtitles(t,e){try{const n=`${this.apiBase}/x/player/wbi/v2?bvid=${t}&cid=${e}`,o=await fetch(n,{credentials:"include",headers:{Referer:"https://www.bilibili.com","User-Agent":navigator.userAgent}});if(!o.ok)return await this.getSubtitlesFromDOM();const i=await o.json();if(0!==i.code||!i.data?.subtitle?.subtitles?.length)return await this.getSubtitlesFromDOM();const r=i.data.subtitle.subtitles,a=r.find(t=>"zh-CN"===t.lan||"zh-Hans"===t.lan||"zh-Hant"===t.lan||t.lan_doc?.includes("ä¸­æ–‡"))||r[0];if(!a||!a.subtitle_url)return await this.getSubtitlesFromDOM();const l=a.subtitle_url.startsWith("http")?a.subtitle_url:`https:${a.subtitle_url}`,s=await fetch(l),c=await s.json();return c.body&&Array.isArray(c.body)?this.formatSubtitles(c.body):await this.getSubtitlesFromDOM()}catch(t){return await this.getSubtitlesFromDOM()}}async getSubtitlesFromDOM(){try{const t=window.__INITIAL_STATE__;if(t?.videoData?.subtitle?.list){const e=t.videoData.subtitle.list;if(e.length>0){const t=e[0];if(t.subtitle_url){const e=t.subtitle_url.startsWith("http")?t.subtitle_url:`https:${t.subtitle_url}`,n=await fetch(e),o=await n.json();if(o.body)return this.formatSubtitles(o.body)}}}return null}catch(t){return null}}async getTopComments(t,e){try{const n=t||e,o=`${this.apiBase}/x/v2/reply?type=1&oid=${n}&sort=2&ps=20`,i=await fetch(o,{credentials:"include",headers:{Referer:"https://www.bilibili.com"}});if(!i.ok)return null;const r=await i.json();if(0!==r.code||!r.data?.replies?.length)return null;const a=[];return r.data.replies.slice(0,10).forEach(t=>{if(t.content?.message&&t.content.message.length>5){const e=t.content.message.trim();e.length>=10&&/[\u4e00-\u9fa5a-zA-Z]/.test(e)&&a.push({text:e,likes:t.like||0})}}),a.length>0?(a.sort((t,e)=>e.likes-t.likes),{fullText:a.map(t=>t.text).join("\n"),count:a.length,topLikes:a[0]?.likes||0}):null}catch(t){return null}}generateTagDescription(t){return t&&0!==t.length?`æœ¬è§†é¢‘çš„ä¸»é¢˜æ ‡ç­¾åŒ…æ‹¬ï¼š${t.slice(0,8).join("ã€")}ã€‚`:""}generateStatsDescription(t){if(!t)return"";const e=[];return t.view>1e4&&e.push(`è¯¥è§†é¢‘æ’­æ”¾é‡è¾¾åˆ°${(t.view/1e4).toFixed(1)}ä¸‡`),t.like>1e3&&e.push(`è·å¾—${(t.like/1e4).toFixed(1)}ä¸‡ç‚¹èµ`),t.coin>500&&e.push(`${(t.coin/1e4).toFixed(1)}ä¸‡æŠ•å¸`),e.length>0?e.join("ï¼Œ")+"ï¼Œè¯´æ˜å†…å®¹å—åˆ°è§‚ä¼—æ¬¢è¿ã€‚":""}formatSubtitles(t){const e={fullText:"",segments:[]};return t.forEach(t=>{const n=t.content||"",o=this.formatTime(t.from||0);e.fullText+=n+" ",e.segments.push({time:t.from,timestamp:o,text:n})}),e.fullText=e.fullText.trim(),e}formatTime(t){const e=Math.floor(t/3600),n=Math.floor(t%3600/60),o=Math.floor(t%60);return e>0?`${e}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`:`${n}:${o.toString().padStart(2,"0")}`}async extractVideoContent(){try{console.log("ğŸ¬ å¼€å§‹æå– Bilibili è§†é¢‘å†…å®¹...");const t=this.extractVideoInfoFromPage();if(console.log("ğŸ“Š Bilibiliè§†é¢‘ä¿¡æ¯:",t),!t.bvid&&!t.aid)throw new Error("æ— æ³•è·å–è§†é¢‘ID");let e=[],n=null,o=null;if(t.bvid&&t.cid&&(console.log("ğŸ“ å°è¯•è·å–å­—å¹•..."),n=await this.getSubtitles(t.bvid,t.cid),n&&n.fullText&&(e.push({source:"å­—å¹•",content:n.fullText,weight:10}),console.log("âœ… æˆåŠŸè·å–å­—å¹•:",n.fullText.length,"å­—"))),n||!t.aid&&!t.bvid||(console.log("ğŸ’¬ å­—å¹•ä¸å¯ç”¨ï¼Œå°è¯•è·å–çƒ­é—¨è¯„è®º..."),o=await this.getTopComments(t.aid,t.bvid),o&&o.fullText&&(e.push({source:"çƒ­é—¨è¯„è®º",content:o.fullText,weight:7}),console.log("âœ… æˆåŠŸè·å–è¯„è®º:",o.count,"æ¡"))),t.description&&t.description.length>10&&(e.push({source:"ç®€ä»‹",content:t.description,weight:n?3:o?6:9}),console.log("ğŸ“„ æ·»åŠ è§†é¢‘ç®€ä»‹:",t.description.length,"å­—")),t.tags&&t.tags.length>0){const n=this.generateTagDescription(t.tags);n&&(e.push({source:"æ ‡ç­¾",content:n,weight:2}),console.log("ğŸ·ï¸ æ·»åŠ æ ‡ç­¾æè¿°"))}const i=this.generateStatsDescription({view:t.view,like:t.like,coin:t.coin});i&&(e.push({source:"ç»Ÿè®¡",content:i,weight:1}),console.log("ğŸ“Š æ·»åŠ ç»Ÿè®¡æè¿°"));let r="",a=[];return e.length>0&&(e.sort((t,e)=>e.weight-t.weight),e.forEach(t=>{t.content&&(r+=t.content+"\n\n",a.push(t.source))}),r=r.trim()),r||(r=t.title,a.push("æ ‡é¢˜"),console.warn("âš ï¸ æ— æ³•è·å–è§†é¢‘å†…å®¹ï¼Œä½¿ç”¨æ ‡é¢˜")),console.log("ğŸ‰ å†…å®¹æå–å®Œæˆï¼æ¥æº:",a.join(" + "),"æ€»é•¿åº¦:",r.length,"å­—"),{type:"video-bilibili",title:t.title,url:window.location.href,videoInfo:t,content:r,contentSources:a,metadata:{duration:t.duration,author:t.author,cover:t.cover,pubdate:t.pubdate,tags:t.tags,stats:{view:t.view,like:t.like}},subtitles:n?{available:!0,fullText:n.fullText,segments:n.segments,method:"api"}:{available:!1,message:o?`è¯¥è§†é¢‘æ²¡æœ‰å­—å¹•ï¼Œå·²è·å– ${o.count} æ¡çƒ­é—¨è¯„è®ºä½œä¸ºè¡¥å……`:"è¯¥è§†é¢‘æ²¡æœ‰å­—å¹•ï¼Œå·²ç»¼åˆç®€ä»‹ã€æ ‡ç­¾ç­‰ä¿¡æ¯ç”Ÿæˆæ‘˜è¦"},comments:o?{available:!0,count:o.count,topLikes:o.topLikes,sample:o.fullText.substring(0,300)+(o.fullText.length>300?"...":"")}:null}}catch(t){throw console.error("âŒ æå–Bilibiliè§†é¢‘å†…å®¹å¤±è´¥:",t),t}}static isBilibiliVideoPage(){return window.location.hostname.includes("bilibili.com")&&window.location.pathname.includes("/video/")}}window.BilibiliAdapter=t,console.log("âœ… BilibiliAdapter å·²é›†æˆåˆ° content.js å¹¶å¯¼å‡º")}if(window.location.hostname.includes("youtube.com")&&"/watch"===window.location.pathname||window.location.hostname.includes("youtu.be")){console.log("ğŸ¬ æ£€æµ‹åˆ° YouTube è§†é¢‘é¡µé¢ï¼Œåˆå§‹åŒ–é€‚é…å™¨...");class t{constructor(){this.apiBase="https://www.youtube.com"}extractVideoId(t){const e=t.match(/[?&]v=([^&]+)/);if(e)return e[1];const n=t.match(/youtu\.be\/([^?]+)/);return n?n[1]:null}extractVideoInfoFromPage(){try{let t=null;if(window.ytInitialPlayerResponse&&(t=window.ytInitialPlayerResponse.videoDetails),!t){const e=document.querySelectorAll("script");for(const n of e){const e=n.textContent;if(e.includes("ytInitialPlayerResponse")){const n=e.match(/ytInitialPlayerResponse\s*=\s*(\{.+?\});/);if(n)try{t=JSON.parse(n[1]).videoDetails;break}catch(t){console.warn("è§£æ ytInitialPlayerResponse å¤±è´¥:",t)}}}}if(!t)throw new Error("æ— æ³•ä»é¡µé¢è·å–è§†é¢‘ä¿¡æ¯");let e="";try{if(window.ytInitialData){const t=window.ytInitialData.contents?.twoColumnWatchNextResults?.results?.results?.contents;if(t){const n=t.find(t=>t.videoSecondaryInfoRenderer);if(n){const t=n.videoSecondaryInfoRenderer?.attributedDescription?.content;e=t||""}}}}catch(t){console.warn("æå–æè¿°å¤±è´¥:",t)}return{videoId:t.videoId,title:t.title||document.title.replace(" - YouTube",""),description:e||"",duration:parseInt(t.lengthSeconds)||0,author:t.author||"",channelId:t.channelId||"",viewCount:parseInt(t.viewCount)||0,thumbnail:t.thumbnail?.thumbnails?.[0]?.url||""}}catch(t){return console.error("æå– YouTube è§†é¢‘ä¿¡æ¯å¤±è´¥:",t),this.extractBasicInfoFromDOM()}}extractBasicInfoFromDOM(){const t=document.querySelector("h1.ytd-video-primary-info-renderer")||document.querySelector("h1.title"),e=document.querySelector("ytd-channel-name a")||document.querySelector("#owner-name a");return{videoId:this.extractVideoId(window.location.href)||"",title:t?.textContent?.trim()||document.title.replace(" - YouTube",""),description:"",duration:0,author:e?.textContent?.trim()||"",channelId:"",viewCount:0,thumbnail:""}}async getSubtitles(t){try{console.log("ğŸ“ å°è¯•è·å– YouTube å­—å¹•...");const e=`https://www.youtube.com/api/timedtext?v=${t}&type=list`,n=await fetch(e);if(!n.ok)return console.warn("æ— æ³•è·å–å­—å¹•åˆ—è¡¨"),null;const o=await n.text(),i=new DOMParser,r=i.parseFromString(o,"text/xml").querySelectorAll("track");if(0===r.length)return console.log("è¯¥è§†é¢‘æ²¡æœ‰å­—å¹•"),null;let a=null;for(const t of r){const e=t.getAttribute("lang_code");if(e?.includes("zh")||e?.includes("ch")){a=t;break}}if(!a)for(const t of r)if("en"===t.getAttribute("lang_code")){a=t;break}if(!a&&r.length>0&&(a=r[0]),!a)return null;const l=a.getAttribute("lang_code");console.log("âœ… æ‰¾åˆ°å­—å¹•:",a.getAttribute("name"),`(${l})`);const s=`https://www.youtube.com/api/timedtext?v=${t}&lang=${l}`,c=await fetch(s),u=await c.text(),d=i.parseFromString(u,"text/xml").querySelectorAll("text");if(0===d.length)return console.warn("å­—å¹•å†…å®¹ä¸ºç©º"),null;let h="";const g=[];return d.forEach(t=>{const e=t.textContent.trim(),n=parseFloat(t.getAttribute("start"))||0;e&&(h+=e+" ",g.push({time:n,timestamp:this.formatTime(n),text:e}))}),h=h.trim(),console.log("ğŸ‰ æˆåŠŸè·å–å­—å¹•ï¼Œå…±",g.length,"æ¡"),{fullText:h,segments:g,language:l}}catch(t){return console.error("è·å– YouTube å­—å¹•å¤±è´¥:",t),null}}async getTopComments(){try{console.log("ğŸ’¬ å°è¯•ä»é¡µé¢æå–è¯„è®º..."),await new Promise(t=>setTimeout(t,1e3));const t=document.querySelectorAll("ytd-comment-thread-renderer");if(0===t.length)return console.log("é¡µé¢ä¸Šæ²¡æœ‰æ‰¾åˆ°è¯„è®º"),null;const e=[];for(let n=0;n<Math.min(10,t.length);n++){const o=t[n],i=o.querySelector("#content-text"),r=o.querySelector("#vote-count-middle");if(i){const t=i.textContent.trim(),n=r?.textContent.trim()||"0";t.length>=10&&/[\u4e00-\u9fa5a-zA-Z]/.test(t)&&e.push({text:t,likes:this.parseLikeCount(n)})}}return e.length>0?(e.sort((t,e)=>e.likes-t.likes),console.log("âœ… æˆåŠŸæå–",e.length,"æ¡è¯„è®º"),{fullText:e.map(t=>t.text).join("\n"),count:e.length,topLikes:e[0]?.likes||0}):null}catch(t){return console.error("æå–è¯„è®ºå¤±è´¥:",t),null}}parseLikeCount(t){return t?(t=t.toLowerCase().trim()).includes("k")?1e3*parseFloat(t):t.includes("m")?1e6*parseFloat(t):parseInt(t)||0:0}formatTime(t){const e=Math.floor(t/3600),n=Math.floor(t%3600/60),o=Math.floor(t%60);return e>0?`${e}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`:`${n}:${o.toString().padStart(2,"0")}`}async extractVideoContent(){try{console.log("ğŸ¬ å¼€å§‹æå– YouTube è§†é¢‘å†…å®¹...");const t=this.extractVideoInfoFromPage();if(console.log("ğŸ“Š YouTube è§†é¢‘ä¿¡æ¯:",t),!t.videoId)throw new Error("æ— æ³•è·å–è§†é¢‘ID");let e=[],n=null,o=null;n=await this.getSubtitles(t.videoId),n&&n.fullText&&(e.push({source:"å­—å¹•",content:n.fullText,weight:10}),console.log("âœ… æˆåŠŸè·å–å­—å¹•:",n.fullText.length,"å­—")),n||(console.log("ğŸ’¬ å­—å¹•ä¸å¯ç”¨ï¼Œå°è¯•æå–è¯„è®º..."),o=await this.getTopComments(),o&&o.fullText&&(e.push({source:"çƒ­é—¨è¯„è®º",content:o.fullText,weight:7}),console.log("âœ… æˆåŠŸè·å–è¯„è®º:",o.count,"æ¡"))),t.description&&t.description.length>10&&(e.push({source:"ç®€ä»‹",content:t.description,weight:n?3:o?6:9}),console.log("ğŸ“„ æ·»åŠ è§†é¢‘ç®€ä»‹:",t.description.length,"å­—"));let i="",r=[];return e.length>0&&(e.sort((t,e)=>e.weight-t.weight),e.forEach(t=>{t.content&&(i+=t.content+"\n\n",r.push(t.source))}),i=i.trim()),i||(i=t.title,r.push("æ ‡é¢˜"),console.warn("âš ï¸ æ— æ³•è·å–è§†é¢‘å†…å®¹ï¼Œä½¿ç”¨æ ‡é¢˜")),console.log("ğŸ‰ å†…å®¹æå–å®Œæˆï¼æ¥æº:",r.join(" + "),"æ€»é•¿åº¦:",i.length,"å­—"),{type:"video-youtube",title:t.title,url:window.location.href,videoInfo:t,content:i,contentSources:r,metadata:{duration:t.duration,author:t.author,thumbnail:t.thumbnail,viewCount:t.viewCount},subtitles:n?{available:!0,fullText:n.fullText,segments:n.segments,language:n.language}:{available:!1,message:o?`è¯¥è§†é¢‘æ²¡æœ‰å­—å¹•ï¼Œå·²æå– ${o.count} æ¡çƒ­é—¨è¯„è®ºä½œä¸ºè¡¥å……`:"è¯¥è§†é¢‘æ²¡æœ‰å­—å¹•ï¼Œå·²ä½¿ç”¨ç®€ä»‹ç”Ÿæˆæ‘˜è¦"},comments:o?{available:!0,count:o.count,topLikes:o.topLikes,sample:o.fullText.substring(0,300)+(o.fullText.length>300?"...":"")}:null}}catch(t){throw console.error("âŒ æå– YouTube è§†é¢‘å†…å®¹å¤±è´¥:",t),t}}static isYouTubeVideoPage(){return window.location.hostname.includes("youtube.com")&&"/watch"===window.location.pathname||window.location.hostname.includes("youtu.be")}}window.YouTubeAdapter=t,console.log("âœ… YouTubeAdapter å·²é›†æˆåˆ° content.js å¹¶å¯¼å‡º")}if(window.location.href.endsWith(".pdf")||"application/pdf"===document.contentType||window.location.href.includes("chrome-extension://")&&window.location.href.includes(".pdf")){console.log("ğŸ“„ æ£€æµ‹åˆ° PDF æ–‡ä»¶ï¼Œåˆå§‹åŒ–é€‚é…å™¨...");class t{constructor(){this.pdfDocument=null}async ensurePDFJS(){if("undefined"!=typeof pdfjsLib)return!0;if(void 0!==window.PDFViewerApplication)return!0;try{return await this.loadPDFJS(),!0}catch(t){return console.error("æ— æ³•åŠ è½½ PDF.js:",t),!1}}async loadPDFJS(){return new Promise((t,e)=>{if("undefined"!=typeof pdfjsLib)return void t();const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",n.onload=()=>{"undefined"!=typeof pdfjsLib?(pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",t()):e(new Error("PDF.js åŠ è½½å¤±è´¥"))},n.onerror=()=>e(new Error("æ— æ³•åŠ è½½ PDF.js è„šæœ¬")),document.head.appendChild(n)})}async extractFromChromeViewer(){try{if(console.log("ğŸ” å°è¯•ä» Chrome PDF Viewer æå–æ–‡æœ¬..."),void 0!==window.PDFViewerApplication&&window.PDFViewerApplication.pdfDocument){const t=window.PDFViewerApplication.pdfDocument,e=t.numPages;console.log(`ğŸ“„ PDF å…± ${e} é¡µ`);let n="";const o=Math.min(e,50);for(let e=1;e<=o;e++)try{const i=await t.getPage(e);n+=(await i.getTextContent()).items.map(t=>t.str).join(" ")+"\n\n",e%5==0&&console.log(`ğŸ“„ å·²æå– ${e}/${o} é¡µ...`)}catch(t){console.warn(`âš ï¸ ç¬¬ ${e} é¡µæå–å¤±è´¥:`,t)}return e>o&&console.log(`â„¹ï¸ PDF å…± ${e} é¡µï¼Œå·²æå–å‰ ${o} é¡µ`),{text:n.trim(),pages:e,extractedPages:o,method:"chrome-viewer"}}return null}catch(t){return console.error("ä» Chrome Viewer æå–å¤±è´¥:",t),null}}async extractUsingPDFJS(t){try{if(console.log("ğŸ” ä½¿ç”¨ PDF.js è§£æ PDF..."),"undefined"==typeof pdfjsLib)throw new Error("PDF.js æœªåŠ è½½");const e=pdfjsLib.getDocument(t),n=await e.promise,o=n.numPages;console.log(`ğŸ“„ PDF å…± ${o} é¡µ`);let i="";const r=Math.min(o,50);for(let t=1;t<=r;t++){const e=await n.getPage(t);i+=(await e.getTextContent()).items.map(t=>t.str).join(" ")+"\n\n",t%5==0&&console.log(`ğŸ“„ å·²æå– ${t}/${r} é¡µ...`)}return o>r&&console.log(`â„¹ï¸ PDF å…± ${o} é¡µï¼Œå·²æå–å‰ ${r} é¡µ`),{text:i.trim(),pages:o,extractedPages:r,method:"pdfjs"}}catch(t){return console.error("ä½¿ç”¨ PDF.js è§£æå¤±è´¥:",t),null}}extractFromDOM(){try{console.log("ğŸ” å°è¯•ä» DOM æå–æ–‡æœ¬...");const t=document.querySelectorAll(".textLayer");if(t.length>0){let e="";return t.forEach((t,n)=>{const o=t.textContent||"";e+=o+"\n\n"}),console.log(`âœ… ä» DOM æå–äº† ${t.length} ä¸ªæ–‡æœ¬å±‚`),{text:e.trim(),pages:t.length,extractedPages:t.length,method:"dom"}}const e=document.body.textContent||"";return e.length>100?(console.log("âœ… ä» body æå–äº†æ–‡æœ¬"),{text:e.trim(),pages:1,extractedPages:1,method:"body"}):null}catch(t){return console.error("ä» DOM æå–å¤±è´¥:",t),null}}async extractMetadata(){try{if(void 0!==window.PDFViewerApplication&&window.PDFViewerApplication.pdfDocument){const t=await window.PDFViewerApplication.pdfDocument.getMetadata();return{title:t.info?.Title||"",author:t.info?.Author||"",subject:t.info?.Subject||"",keywords:t.info?.Keywords||"",creator:t.info?.Creator||"",producer:t.info?.Producer||"",creationDate:t.info?.CreationDate||"",modificationDate:t.info?.ModDate||""}}return null}catch(t){return console.warn("æå–å…ƒæ•°æ®å¤±è´¥:",t),null}}getTitleFromURL(){const t=window.location.href.match(/([^\/]+)\.pdf/i);if(t&&t[1]){let e=t[1];return e=decodeURIComponent(e),e=e.replace(/[-_]/g," "),e}return document.title||"PDFæ–‡æ¡£"}async extractPDFContent(){try{console.log("ğŸ“„ å¼€å§‹æå– PDF å†…å®¹...");let t=null;if(t=await this.extractFromChromeViewer(),t&&t.text||await this.ensurePDFJS()&&(t=await this.extractUsingPDFJS(window.location.href)),t&&t.text||(t=this.extractFromDOM()),!t||!t.text)throw new Error("æ— æ³•æå– PDF æ–‡æœ¬å†…å®¹");console.log(`âœ… æˆåŠŸæå– PDF æ–‡æœ¬ï¼Œå…± ${t.text.length} å­—`),console.log(`ğŸ“Š æ–¹æ³•: ${t.method}, é¡µæ•°: ${t.extractedPages}/${t.pages}`);const e=await this.extractMetadata();let n=this.getTitleFromURL();e&&e.title&&(n=e.title);const o=t.text.split("\n\n").filter(t=>t.trim().length>20).slice(0,3).join("\n\n").substring(0,500);return{type:"document-pdf",title:n,url:window.location.href,content:t.text,excerpt:o,metadata:{pages:t.pages,extractedPages:t.extractedPages,extractMethod:t.method,...e,fileSize:this.formatFileSize(t.text.length),wordCount:this.countWords(t.text)},contentSources:["PDFæ–‡æœ¬"]}}catch(t){throw console.error("âŒ æå– PDF å†…å®¹å¤±è´¥:",t),t}}formatFileSize(t){return t<1024?t+" B":t<1048576?(t/1024).toFixed(2)+" KB":(t/1024/1024).toFixed(2)+" MB"}countWords(t){return(t.match(/[\u4e00-\u9fa5]/g)||[]).length+(t.match(/[a-zA-Z]+/g)||[]).length}static isPDFPage(){return window.location.href.endsWith(".pdf")||"application/pdf"===document.contentType||window.location.href.includes("chrome-extension://")&&window.location.href.includes(".pdf")}}window.PDFAdapter=t,console.log("âœ… PDFAdapter å·²é›†æˆåˆ° content.js å¹¶å¯¼å‡º")}function t(){if(document.getElementById("digest-ai-float-button"))return;const t=document.createElement("div");t.id="digest-ai-float-button",t.innerHTML='\n    <div class="float-btn-icon">ğŸ“š</div>\n    <div class="float-btn-tooltip">ä¿å­˜æ–‡ç« </div>\n  ',function(){if(document.getElementById("digest-ai-float-styles"))return;const t=document.createElement("style");t.id="digest-ai-float-styles",t.textContent="\n    #digest-ai-float-button {\n      position: fixed;\n      right: 20px;\n      bottom: 100px;\n      width: 56px;\n      height: 56px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      border-radius: 50%;\n      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n      cursor: pointer;\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      user-select: none;\n    }\n    \n    #digest-ai-float-button:hover {\n      transform: scale(1.1);\n      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);\n    }\n    \n    #digest-ai-float-button:active {\n      transform: scale(0.95);\n    }\n    \n    #digest-ai-float-button.dragging {\n      cursor: grabbing;\n      opacity: 0.8;\n    }\n    \n    .float-btn-icon {\n      font-size: 24px;\n      line-height: 1;\n    }\n    \n    .float-btn-tooltip {\n      position: absolute;\n      right: 70px;\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 6px 12px;\n      border-radius: 6px;\n      font-size: 13px;\n      white-space: nowrap;\n      opacity: 0;\n      pointer-events: none;\n      transition: opacity 0.2s;\n    }\n    \n    #digest-ai-float-button:hover .float-btn-tooltip {\n      opacity: 1;\n    }\n    \n    .float-btn-tooltip::after {\n      content: '';\n      position: absolute;\n      right: -6px;\n      top: 50%;\n      transform: translateY(-50%);\n      border: 6px solid transparent;\n      border-left-color: rgba(0, 0, 0, 0.8);\n    }\n    \n    #digest-ai-float-button.saving {\n      animation: digest-ai-pulse 1s ease-in-out infinite;\n    }\n    \n    @keyframes digest-ai-pulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.05); }\n    }\n    \n    .digest-ai-toast {\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0, 0, 0, 0.9);\n      color: white;\n      padding: 12px 24px;\n      border-radius: 8px;\n      font-size: 14px;\n      z-index: 1000000;\n      animation: digest-ai-slideDown 0.3s ease-out;\n    }\n    \n    .digest-ai-toast.success {\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n    }\n    \n    .digest-ai-toast.error {\n      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);\n    }\n    \n    @keyframes digest-ai-slideDown {\n      from {\n        opacity: 0;\n        transform: translateX(-50%) translateY(-20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateX(-50%) translateY(0);\n      }\n    }\n  ",document.head.appendChild(t)}(),document.body.appendChild(t),async function(t){const{floatButtonPosition:e}=await chrome.storage.local.get(["floatButtonPosition"]);e?.left&&e?.top&&(t.style.left=e.left,t.style.top=e.top,t.style.right="auto",t.style.bottom="auto")}(t);let n=!1,o=0,i=0,r=0,a=0;t.addEventListener("mousedown",e=>{if(0!==e.button)return;n=!0,t.classList.add("dragging");const l=t.getBoundingClientRect();r=e.clientX-l.left,a=e.clientY-l.top,o=e.clientX,i=e.clientY,e.preventDefault()}),document.addEventListener("mousemove",e=>{if(!n)return;const o=e.clientX-r,i=e.clientY-a,l=window.innerWidth-t.offsetWidth,s=window.innerHeight-t.offsetHeight;t.style.left=`${Math.max(0,Math.min(o,l))}px`,t.style.top=`${Math.max(0,Math.min(i,s))}px`,t.style.right="auto",t.style.bottom="auto",e.preventDefault()}),document.addEventListener("mouseup",async r=>{n&&(n=!1,t.classList.remove("dragging"),Math.sqrt(Math.pow(r.clientX-o,2)+Math.pow(r.clientY-i,2))<5?await async function(t){t.classList.add("saving");try{const t=await chrome.runtime.sendMessage({action:"saveArticle",url:window.location.href,title:document.title});if(!t||!t.success)throw new Error(t?.error||"ä¿å­˜å¤±è´¥");e("âœ… æ–‡ç« å·²ä¿å­˜","success")}catch(t){console.error("ä¿å­˜æ–‡ç« å¤±è´¥:",t),e("âŒ "+t.message,"error")}finally{t.classList.remove("saving")}}(t):await async function(t){const e={left:t.style.left,top:t.style.top};await chrome.storage.local.set({floatButtonPosition:e})}(t))})}function e(t,e="info"){const n=document.getElementById("digest-ai-toast");n&&n.remove();const o=document.createElement("div");o.id="digest-ai-toast",o.textContent=t,o.className=`digest-ai-toast ${e}`,document.body.appendChild(o),setTimeout(()=>{o.style.animation="digest-ai-slideDown 0.3s ease-out reverse",setTimeout(()=>o.remove(),300)},3e3)}function n(){const t=["h1",".article-title",".post-title",'[property="og:title"]','[name="twitter:title"]'];for(const e of t){const t=document.querySelector(e);if(t)return t.getAttribute("content")||t.textContent.trim()}return document.title}function o(){const t=['[rel="author"]',".author",".byline",'[property="article:author"]','[name="author"]'];for(const e of t){const t=document.querySelector(e);if(t)return t.getAttribute("content")||t.textContent.trim()}return""}function i(){const t=document.querySelector('[property="og:site_name"]');if(t)return t.getAttribute("content");try{return window.location.hostname.replace(/^www\./,"")}catch(t){return""}}!async function(){try{const{enableFloatButton:e}=await chrome.storage.local.get(["enableFloatButton"]),n=void 0===e||e;if(console.log("æ‚¬æµ®çƒè®¾ç½®:",n),!n)return void console.log("æ‚¬æµ®çƒå·²ç¦ç”¨");t()}catch(t){console.error("åˆå§‹åŒ–æ‚¬æµ®çƒå¤±è´¥:",t)}}(),chrome.storage.onChanged.addListener((e,n)=>{if("local"===n&&e.enableFloatButton){const n=e.enableFloatButton.newValue;console.log("æ‚¬æµ®çƒè®¾ç½®å·²æ›´æ”¹:",n);const o=document.getElementById("digest-ai-float-button");if(n&&!o)t();else if(!n&&o){o.remove();const t=document.getElementById("digest-ai-float-styles");t&&t.remove();const e=document.getElementById("digest-ai-toast-styles");e&&e.remove()}}}),chrome.runtime.onMessage.addListener((t,e,r)=>"extractContent"===t.action&&((async()=>{try{const t=await async function(){const t=function(){const t=window.location.href,e=window.location.hostname;return t.endsWith(".pdf")||"application/pdf"===document.contentType||t.includes("chrome-extension://")&&t.includes(".pdf")?"document-pdf":e.includes("bilibili.com")&&t.includes("/video/")?"video-bilibili":e.includes("youtube.com")&&t.includes("/watch")?"video-youtube":"webpage"}();switch(console.log("æ£€æµ‹åˆ°å†…å®¹ç±»å‹:",t),t){case"document-pdf":return await async function(){try{if(console.log("ğŸ“„ ä½¿ç”¨é›†æˆçš„ PDFAdapter æå–æ–‡æ¡£å†…å®¹..."),"undefined"==typeof PDFAdapter)throw new Error("PDFAdapter æœªå®šä¹‰ï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿï¼");const t=new PDFAdapter;return await t.extractPDFContent()}catch(t){throw console.error("âŒ æå– PDF æ–‡æ¡£å¤±è´¥:",t),new Error("æå–æ–‡æ¡£å†…å®¹å¤±è´¥: "+t.message)}}();case"video-bilibili":return await async function(){try{if(console.log("ğŸ¬ ä½¿ç”¨é›†æˆçš„ BilibiliAdapter æå–è§†é¢‘å†…å®¹..."),"undefined"==typeof BilibiliAdapter)throw new Error("BilibiliAdapter æœªå®šä¹‰ï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿï¼");const t=new BilibiliAdapter;return await t.extractVideoContent()}catch(t){throw console.error("âŒ æå–Bilibiliè§†é¢‘å¤±è´¥:",t),new Error("æå–è§†é¢‘å†…å®¹å¤±è´¥: "+t.message)}}();case"video-youtube":return await async function(){try{if(console.log("ğŸ¬ ä½¿ç”¨é›†æˆçš„ YouTubeAdapter æå–è§†é¢‘å†…å®¹..."),"undefined"==typeof YouTubeAdapter)throw new Error("YouTubeAdapter æœªå®šä¹‰ï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿï¼");const t=new YouTubeAdapter;return await t.extractVideoContent()}catch(t){throw console.error("âŒ æå– YouTube è§†é¢‘å¤±è´¥:",t),new Error("æå–è§†é¢‘å†…å®¹å¤±è´¥: "+t.message)}}();default:return function(){const t=document.cloneNode(!0);if("undefined"!=typeof Readability)try{const e=new Readability(t).parse();if(e)return{type:"webpage",title:e.title||document.title,content:e.textContent||"",htmlContent:e.content||"",excerpt:e.excerpt||"",byline:e.byline||"",siteName:i(),length:e.length||0}}catch(t){console.warn("Readability æå–å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•:",t)}return function(){const t=["article",'[role="main"]',"main",".article-content",".post-content",".entry-content","#content",".content"];let e=null;for(const n of t){const t=document.querySelector(n);if(t&&t.textContent.trim().length>200){e=t;break}}e||(e=document.body);const r=function(t){const e=t.cloneNode(!0);["script","style","nav","header","footer","iframe",".ad",".advertisement",".social-share",".comments"].forEach(t=>{e.querySelectorAll(t).forEach(t=>t.remove())});let n=e.textContent||"";return n=n.replace(/\s+/g," ").trim(),n}(e);return{type:"webpage",title:n(),content:r,htmlContent:e.innerHTML,excerpt:r.substring(0,300),byline:o(),siteName:i(),length:r.length}}()}()}}();r({success:!0,content:t})}catch(t){console.error("æå–å†…å®¹å¤±è´¥:",t),r({success:!1,error:t.message})}})(),!0)),"undefined"!=typeof DEBUG&&DEBUG&&console.log("Content script loaded")})();