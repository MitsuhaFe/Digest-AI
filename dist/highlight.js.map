{"version":3,"file":"highlight.js","mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://digest-ai-extension/./scripts/highlight.js"],"sourcesContent":["/**\r\n * åˆ’è¯é«˜äº®å’Œç¬”è®°åŠŸèƒ½\r\n * å¤„ç†æ–‡æœ¬é€‰æ‹©ã€é«˜äº®æ ‡è®°å’Œç¬”è®°æ·»åŠ \r\n */\r\n\r\nclass HighlightManager {\r\n  constructor() {\r\n    this.currentArticleId = null;\r\n    this.highlights = [];\r\n    this.toolbar = null;\r\n    this.notePopup = null;\r\n    this.currentSelection = null;\r\n  }\r\n\r\n  /**\r\n   * åˆå§‹åŒ–é«˜äº®åŠŸèƒ½\r\n   */\r\n  init(articleId, articleBody, highlights = []) {\r\n    this.currentArticleId = articleId;\r\n    this.highlights = highlights;\r\n    this.articleBody = articleBody;\r\n    \r\n    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨\r\n    if (this.mouseupHandler) {\r\n      document.removeEventListener('mouseup', this.mouseupHandler);\r\n    }\r\n    if (this.clickHandler) {\r\n      document.removeEventListener('click', this.clickHandler);\r\n    }\r\n    \r\n    // æ·»åŠ æ–‡æœ¬é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨\r\n    this.mouseupHandler = this.handleTextSelection.bind(this);\r\n    document.addEventListener('mouseup', this.mouseupHandler);\r\n    \r\n    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¤„ç†ç‚¹å‡»é«˜äº®æŸ¥çœ‹ç¬”è®°ï¼‰\r\n    this.clickHandler = this.handleHighlightClick.bind(this);\r\n    document.addEventListener('click', this.clickHandler);\r\n    \r\n    // æ¢å¤å·²æœ‰çš„é«˜äº®\r\n    this.restoreHighlights();\r\n  }\r\n\r\n  /**\r\n   * å¤„ç†æ–‡æœ¬é€‰æ‹©\r\n   */\r\n  handleTextSelection(e) {\r\n    // å¦‚æœç‚¹å‡»çš„æ˜¯å·¥å…·æ æˆ–å¼¹çª—ï¼Œä¸å¤„ç†\r\n    if (this.toolbar && this.toolbar.contains(e.target)) {\r\n      return;\r\n    }\r\n    if (this.notePopup && this.notePopup.contains(e.target)) {\r\n      return;\r\n    }\r\n    \r\n    const selection = window.getSelection();\r\n    const selectedText = selection.toString().trim();\r\n    \r\n    // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬æˆ–æ–‡æœ¬ä¸åœ¨æ–‡ç« æ­£æ–‡ä¸­ï¼Œéšè—å·¥å…·æ \r\n    if (!selectedText || !this.articleBody.contains(selection.anchorNode)) {\r\n      this.hideToolbar();\r\n      return;\r\n    }\r\n    \r\n    // å¦‚æœé€‰ä¸­äº†æ–‡æœ¬ï¼Œæ˜¾ç¤ºå·¥å…·æ \r\n    if (selectedText.length > 0) {\r\n      this.currentSelection = {\r\n        text: selectedText,\r\n        range: selection.getRangeAt(0).cloneRange()\r\n      };\r\n      this.showToolbar(e);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * æ˜¾ç¤ºé«˜äº®å·¥å…·æ \r\n   */\r\n  showToolbar(e) {\r\n    // ç§»é™¤æ—§çš„å·¥å…·æ \r\n    this.hideToolbar();\r\n    \r\n    // åˆ›å»ºå·¥å…·æ \r\n    this.toolbar = document.createElement('div');\r\n    this.toolbar.className = 'highlight-toolbar';\r\n    \r\n    // é¢œè‰²æŒ‰é’®\r\n    const colors = [\r\n      { class: 'color-yellow', emoji: 'ğŸŸ¨', color: 'yellow' },\r\n      { class: 'color-green', emoji: 'ğŸŸ©', color: 'green' },\r\n      { class: 'color-blue', emoji: 'ğŸŸ¦', color: 'blue' },\r\n      { class: 'color-pink', emoji: 'ğŸŸª', color: 'pink' }\r\n    ];\r\n    \r\n    colors.forEach(({ class: className, emoji, color }) => {\r\n      const btn = document.createElement('button');\r\n      btn.className = className;\r\n      btn.textContent = emoji;\r\n      btn.title = `é«˜äº®ä¸º${color}`;\r\n      btn.onclick = () => this.createHighlight(color);\r\n      this.toolbar.appendChild(btn);\r\n    });\r\n    \r\n    // æ·»åŠ ç¬”è®°æŒ‰é’®\r\n    const noteBtn = document.createElement('button');\r\n    noteBtn.className = 'btn-note';\r\n    noteBtn.textContent = 'ğŸ“';\r\n    noteBtn.title = 'æ·»åŠ ç¬”è®°';\r\n    noteBtn.onclick = () => this.showNotePopup();\r\n    this.toolbar.appendChild(noteBtn);\r\n    \r\n    // å–æ¶ˆæŒ‰é’®\r\n    const cancelBtn = document.createElement('button');\r\n    cancelBtn.className = 'btn-cancel';\r\n    cancelBtn.textContent = 'âœ•';\r\n    cancelBtn.title = 'å–æ¶ˆ';\r\n    cancelBtn.onclick = () => this.hideToolbar();\r\n    this.toolbar.appendChild(cancelBtn);\r\n    \r\n    // å®šä½å·¥å…·æ \r\n    document.body.appendChild(this.toolbar);\r\n    const rect = this.currentSelection.range.getBoundingClientRect();\r\n    this.toolbar.style.left = `${rect.left + (rect.width / 2) - (this.toolbar.offsetWidth / 2)}px`;\r\n    this.toolbar.style.top = `${rect.top - this.toolbar.offsetHeight - 10 + window.scrollY}px`;\r\n  }\r\n\r\n  /**\r\n   * éšè—å·¥å…·æ \r\n   */\r\n  hideToolbar() {\r\n    if (this.toolbar) {\r\n      this.toolbar.remove();\r\n      this.toolbar = null;\r\n    }\r\n    window.getSelection().removeAllRanges();\r\n  }\r\n\r\n  /**\r\n   * åˆ›å»ºé«˜äº®\r\n   */\r\n  createHighlight(color, note = '') {\r\n    if (!this.currentSelection) return;\r\n    \r\n    const highlight = {\r\n      id: Date.now().toString(),\r\n      text: this.currentSelection.text,\r\n      color: color,\r\n      note: note,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n    \r\n    this.highlights.push(highlight);\r\n    this.hideToolbar();\r\n    this.restoreHighlights();\r\n    this.saveHighlights();\r\n  }\r\n\r\n  /**\r\n   * æ¢å¤æ‰€æœ‰é«˜äº®\r\n   */\r\n  restoreHighlights() {\r\n    // æ¸…é™¤ç°æœ‰é«˜äº®æ ‡è®°\r\n    const existingHighlights = this.articleBody.querySelectorAll('.highlight');\r\n    existingHighlights.forEach(el => {\r\n      const parent = el.parentNode;\r\n      while (el.firstChild) {\r\n        parent.insertBefore(el.firstChild, el);\r\n      }\r\n      parent.removeChild(el);\r\n    });\r\n    \r\n    // é‡æ–°åº”ç”¨æ‰€æœ‰é«˜äº®\r\n    this.highlights.forEach(highlight => {\r\n      this.applyHighlight(highlight);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * åº”ç”¨å•ä¸ªé«˜äº®\r\n   */\r\n  applyHighlight(highlight) {\r\n    const walker = document.createTreeWalker(\r\n      this.articleBody,\r\n      NodeFilter.SHOW_TEXT,\r\n      null,\r\n      false\r\n    );\r\n    \r\n    let node;\r\n    while (node = walker.nextNode()) {\r\n      const text = node.textContent;\r\n      const index = text.indexOf(highlight.text);\r\n      \r\n      if (index !== -1) {\r\n        const range = document.createRange();\r\n        range.setStart(node, index);\r\n        range.setEnd(node, index + highlight.text.length);\r\n        \r\n        const span = document.createElement('span');\r\n        span.className = `highlight highlight-${highlight.color}`;\r\n        if (highlight.note) {\r\n          span.classList.add('has-note');\r\n        }\r\n        span.dataset.highlightId = highlight.id;\r\n        \r\n        try {\r\n          range.surroundContents(span);\r\n          break; // åªé«˜äº®ç¬¬ä¸€æ¬¡å‡ºç°\r\n        } catch (e) {\r\n          console.warn('æ— æ³•åº”ç”¨é«˜äº®:', e);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * æ˜¾ç¤ºç¬”è®°å¼¹çª—\r\n   */\r\n  showNotePopup(existingNote = '', highlightId = null) {\r\n    this.hideNotePopup();\r\n    \r\n    this.notePopup = document.createElement('div');\r\n    this.notePopup.className = 'note-popup';\r\n    \r\n    const textarea = document.createElement('textarea');\r\n    textarea.placeholder = 'è¾“å…¥ç¬”è®°...';\r\n    textarea.value = existingNote;\r\n    \r\n    const actions = document.createElement('div');\r\n    actions.className = 'note-popup-actions';\r\n    \r\n    const saveBtn = document.createElement('button');\r\n    saveBtn.className = 'btn-save';\r\n    saveBtn.textContent = 'ä¿å­˜';\r\n    saveBtn.onclick = () => {\r\n      const note = textarea.value.trim();\r\n      if (highlightId) {\r\n        // æ›´æ–°ç°æœ‰ç¬”è®°\r\n        const highlight = this.highlights.find(h => h.id === highlightId);\r\n        if (highlight) {\r\n          highlight.note = note;\r\n          this.restoreHighlights();\r\n          this.saveHighlights();\r\n        }\r\n      } else if (this.currentSelection) {\r\n        // åˆ›å»ºæ–°é«˜äº®å¸¦ç¬”è®°\r\n        this.createHighlight('yellow', note);\r\n      }\r\n      this.hideNotePopup();\r\n    };\r\n    \r\n    const cancelBtn = document.createElement('button');\r\n    cancelBtn.className = 'btn-cancel';\r\n    cancelBtn.textContent = 'å–æ¶ˆ';\r\n    cancelBtn.onclick = () => this.hideNotePopup();\r\n    \r\n    actions.appendChild(saveBtn);\r\n    actions.appendChild(cancelBtn);\r\n    this.notePopup.appendChild(textarea);\r\n    this.notePopup.appendChild(actions);\r\n    \r\n    // å®šä½å¼¹çª—\r\n    document.body.appendChild(this.notePopup);\r\n    if (this.toolbar) {\r\n      const rect = this.toolbar.getBoundingClientRect();\r\n      this.notePopup.style.left = `${rect.left}px`;\r\n      this.notePopup.style.top = `${rect.bottom + 10}px`;\r\n    } else {\r\n      this.notePopup.style.left = '50%';\r\n      this.notePopup.style.top = '50%';\r\n      this.notePopup.style.transform = 'translate(-50%, -50%)';\r\n    }\r\n    \r\n    textarea.focus();\r\n  }\r\n\r\n  /**\r\n   * éšè—ç¬”è®°å¼¹çª—\r\n   */\r\n  hideNotePopup() {\r\n    if (this.notePopup) {\r\n      this.notePopup.remove();\r\n      this.notePopup = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * å¤„ç†ç‚¹å‡»é«˜äº®æ–‡æœ¬\r\n   */\r\n  handleHighlightClick(e) {\r\n    const highlightEl = e.target.closest('.highlight');\r\n    if (!highlightEl) return;\r\n    \r\n    const highlightId = highlightEl.dataset.highlightId;\r\n    const highlight = this.highlights.find(h => h.id === highlightId);\r\n    \r\n    if (!highlight) return;\r\n    \r\n    // æ˜¾ç¤ºç¬”è®°æˆ–é«˜äº®ä¿¡æ¯\r\n    this.showHighlightInfo(highlight, e);\r\n  }\r\n\r\n  /**\r\n   * æ˜¾ç¤ºé«˜äº®ä¿¡æ¯\r\n   */\r\n  showHighlightInfo(highlight, e) {\r\n    // ç§»é™¤ç°æœ‰çš„ä¿¡æ¯æ˜¾ç¤º\r\n    const existing = document.querySelector('.note-display');\r\n    if (existing) existing.remove();\r\n    \r\n    const display = document.createElement('div');\r\n    display.className = 'note-display';\r\n    \r\n    // å¤´éƒ¨\r\n    const header = document.createElement('div');\r\n    header.className = 'note-display-header';\r\n    const title = document.createElement('strong');\r\n    title.textContent = highlight.note ? 'ğŸ“ ç¬”è®°' : 'âœ¨ é«˜äº®';\r\n    const closeBtn = document.createElement('button');\r\n    closeBtn.className = 'note-display-close';\r\n    closeBtn.textContent = 'âœ•';\r\n    closeBtn.onclick = () => display.remove();\r\n    header.appendChild(title);\r\n    header.appendChild(closeBtn);\r\n    \r\n    // å†…å®¹\r\n    if (highlight.note) {\r\n      const content = document.createElement('div');\r\n      content.className = 'note-display-content';\r\n      content.textContent = highlight.note;\r\n      display.appendChild(header);\r\n      display.appendChild(content);\r\n    } else {\r\n      display.appendChild(header);\r\n    }\r\n    \r\n    // æ“ä½œæŒ‰é’®\r\n    const actions = document.createElement('div');\r\n    actions.className = 'note-display-actions';\r\n    \r\n    const editBtn = document.createElement('button');\r\n    editBtn.textContent = highlight.note ? 'âœï¸ ç¼–è¾‘ç¬”è®°' : 'ğŸ“ æ·»åŠ ç¬”è®°';\r\n    editBtn.onclick = () => {\r\n      display.remove();\r\n      this.showNotePopup(highlight.note, highlight.id);\r\n    };\r\n    \r\n    const deleteBtn = document.createElement('button');\r\n    deleteBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤';\r\n    deleteBtn.onclick = () => {\r\n      this.deleteHighlight(highlight.id);\r\n      display.remove();\r\n    };\r\n    \r\n    actions.appendChild(editBtn);\r\n    actions.appendChild(deleteBtn);\r\n    display.appendChild(actions);\r\n    \r\n    // å®šä½\r\n    document.body.appendChild(display);\r\n    const rect = e.target.getBoundingClientRect();\r\n    display.style.left = `${rect.left}px`;\r\n    display.style.top = `${rect.bottom + 10 + window.scrollY}px`;\r\n  }\r\n\r\n  /**\r\n   * åˆ é™¤é«˜äº®\r\n   */\r\n  deleteHighlight(highlightId) {\r\n    this.highlights = this.highlights.filter(h => h.id !== highlightId);\r\n    this.restoreHighlights();\r\n    this.saveHighlights();\r\n  }\r\n\r\n  /**\r\n   * ä¿å­˜é«˜äº®åˆ°å­˜å‚¨\r\n   */\r\n  async saveHighlights() {\r\n    if (!this.currentArticleId) return;\r\n    \r\n    try {\r\n      // è·å–æ‰€æœ‰æ–‡ç« \r\n      const result = await chrome.storage.local.get(['articles']);\r\n      const articles = result.articles || [];\r\n      \r\n      // æ‰¾åˆ°å½“å‰æ–‡ç« å¹¶æ›´æ–°é«˜äº®\r\n      const article = articles.find(a => a.id === this.currentArticleId);\r\n      if (article) {\r\n        article.highlights = this.highlights;\r\n        await chrome.storage.local.set({ articles });\r\n      }\r\n    } catch (error) {\r\n      console.error('ä¿å­˜é«˜äº®å¤±è´¥:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * æ¸…ç†\r\n   */\r\n  destroy() {\r\n    this.hideToolbar();\r\n    this.hideNotePopup();\r\n    if (this.mouseupHandler) {\r\n      document.removeEventListener('mouseup', this.mouseupHandler);\r\n    }\r\n    if (this.clickHandler) {\r\n      document.removeEventListener('click', this.clickHandler);\r\n    }\r\n  }\r\n}\r\n\r\n// å¯¼å‡ºå•ä¾‹\r\nif (typeof window !== 'undefined') {\r\n  window.HighlightManager = HighlightManager;\r\n  window.highlightManager = new HighlightManager();\r\n}\r\n\r\n"],"names":[],"sourceRoot":""}