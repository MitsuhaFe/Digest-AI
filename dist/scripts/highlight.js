class HighlightManager{constructor(){this.currentArticleId=null,this.highlights=[],this.toolbar=null,this.notePopup=null,this.currentSelection=null}init(t,e,o=[]){this.currentArticleId=t,this.highlights=o,this.articleBody=e,this.mouseupHandler&&document.removeEventListener("mouseup",this.mouseupHandler),this.clickHandler&&document.removeEventListener("click",this.clickHandler),this.mouseupHandler=this.handleTextSelection.bind(this),document.addEventListener("mouseup",this.mouseupHandler),this.clickHandler=this.handleHighlightClick.bind(this),document.addEventListener("click",this.clickHandler),this.restoreHighlights()}handleTextSelection(t){if(this.toolbar&&this.toolbar.contains(t.target))return;if(this.notePopup&&this.notePopup.contains(t.target))return;const e=window.getSelection(),o=e.toString().trim();o&&this.articleBody.contains(e.anchorNode)?o.length>0&&(this.currentSelection={text:o,range:e.getRangeAt(0).cloneRange()},this.showToolbar(t)):this.hideToolbar()}showToolbar(t){this.hideToolbar(),this.toolbar=document.createElement("div"),this.toolbar.className="highlight-toolbar",[{class:"color-yellow",emoji:"ğŸŸ¨",color:"yellow"},{class:"color-green",emoji:"ğŸŸ©",color:"green"},{class:"color-blue",emoji:"ğŸŸ¦",color:"blue"},{class:"color-pink",emoji:"ğŸŸª",color:"pink"}].forEach(({class:t,emoji:e,color:o})=>{const i=document.createElement("button");i.className=t,i.textContent=e,i.title=`é«˜äº®ä¸º${o}`,i.onclick=()=>this.createHighlight(o),this.toolbar.appendChild(i)});const e=document.createElement("button");e.className="btn-note",e.textContent="ğŸ“",e.title="æ·»åŠ ç¬”è®°",e.onclick=()=>this.showNotePopup(),this.toolbar.appendChild(e);const o=document.createElement("button");o.className="btn-cancel",o.textContent="âœ•",o.title="å–æ¶ˆ",o.onclick=()=>this.hideToolbar(),this.toolbar.appendChild(o),document.body.appendChild(this.toolbar);const i=this.currentSelection.range.getBoundingClientRect();this.toolbar.style.left=i.left+i.width/2-this.toolbar.offsetWidth/2+"px",this.toolbar.style.top=`${i.top-this.toolbar.offsetHeight-10+window.scrollY}px`}hideToolbar(){this.toolbar&&(this.toolbar.remove(),this.toolbar=null),window.getSelection().removeAllRanges()}createHighlight(t,e=""){if(!this.currentSelection)return;const o={id:Date.now().toString(),text:this.currentSelection.text,color:t,note:e,timestamp:(new Date).toISOString()};this.highlights.push(o),this.hideToolbar(),this.restoreHighlights(),this.saveHighlights()}restoreHighlights(){this.articleBody.querySelectorAll(".highlight").forEach(t=>{const e=t.parentNode;for(;t.firstChild;)e.insertBefore(t.firstChild,t);e.removeChild(t)}),this.highlights.forEach(t=>{this.applyHighlight(t)})}applyHighlight(t){const e=document.createTreeWalker(this.articleBody,NodeFilter.SHOW_TEXT,null,!1);let o;for(;o=e.nextNode();){const e=o.textContent.indexOf(t.text);if(-1!==e){const i=document.createRange();i.setStart(o,e),i.setEnd(o,e+t.text.length);const n=document.createElement("span");n.className=`highlight highlight-${t.color}`,t.note&&n.classList.add("has-note"),n.dataset.highlightId=t.id;try{i.surroundContents(n);break}catch(t){console.warn("æ— æ³•åº”ç”¨é«˜äº®:",t)}}}}showNotePopup(t="",e=null){this.hideNotePopup(),this.notePopup=document.createElement("div"),this.notePopup.className="note-popup";const o=document.createElement("textarea");o.placeholder="è¾“å…¥ç¬”è®°...",o.value=t;const i=document.createElement("div");i.className="note-popup-actions";const n=document.createElement("button");n.className="btn-save",n.textContent="ä¿å­˜",n.onclick=()=>{const t=o.value.trim();if(e){const o=this.highlights.find(t=>t.id===e);o&&(o.note=t,this.restoreHighlights(),this.saveHighlights())}else this.currentSelection&&this.createHighlight("yellow",t);this.hideNotePopup()};const l=document.createElement("button");if(l.className="btn-cancel",l.textContent="å–æ¶ˆ",l.onclick=()=>this.hideNotePopup(),i.appendChild(n),i.appendChild(l),this.notePopup.appendChild(o),this.notePopup.appendChild(i),document.body.appendChild(this.notePopup),this.toolbar){const t=this.toolbar.getBoundingClientRect();this.notePopup.style.left=`${t.left}px`,this.notePopup.style.top=`${t.bottom+10}px`}else this.notePopup.style.left="50%",this.notePopup.style.top="50%",this.notePopup.style.transform="translate(-50%, -50%)";o.focus()}hideNotePopup(){this.notePopup&&(this.notePopup.remove(),this.notePopup=null)}handleHighlightClick(t){const e=t.target.closest(".highlight");if(!e)return;const o=e.dataset.highlightId,i=this.highlights.find(t=>t.id===o);i&&this.showHighlightInfo(i,t)}showHighlightInfo(t,e){const o=document.querySelector(".note-display");o&&o.remove();const i=document.createElement("div");i.className="note-display";const n=document.createElement("div");n.className="note-display-header";const l=document.createElement("strong");l.textContent=t.note?"ğŸ“ ç¬”è®°":"âœ¨ é«˜äº®";const s=document.createElement("button");if(s.className="note-display-close",s.textContent="âœ•",s.onclick=()=>i.remove(),n.appendChild(l),n.appendChild(s),t.note){const e=document.createElement("div");e.className="note-display-content",e.textContent=t.note,i.appendChild(n),i.appendChild(e)}else i.appendChild(n);const h=document.createElement("div");h.className="note-display-actions";const c=document.createElement("button");c.textContent=t.note?"âœï¸ ç¼–è¾‘ç¬”è®°":"ğŸ“ æ·»åŠ ç¬”è®°",c.onclick=()=>{i.remove(),this.showNotePopup(t.note,t.id)};const a=document.createElement("button");a.textContent="ğŸ—‘ï¸ åˆ é™¤",a.onclick=()=>{this.deleteHighlight(t.id),i.remove()},h.appendChild(c),h.appendChild(a),i.appendChild(h),document.body.appendChild(i);const r=e.target.getBoundingClientRect();i.style.left=`${r.left}px`,i.style.top=`${r.bottom+10+window.scrollY}px`}deleteHighlight(t){this.highlights=this.highlights.filter(e=>e.id!==t),this.restoreHighlights(),this.saveHighlights()}async saveHighlights(){if(this.currentArticleId)try{const t=(await chrome.storage.local.get(["articles"])).articles||[],e=t.find(t=>t.id===this.currentArticleId);e&&(e.highlights=this.highlights,await chrome.storage.local.set({articles:t}))}catch(t){console.error("ä¿å­˜é«˜äº®å¤±è´¥:",t)}}destroy(){this.hideToolbar(),this.hideNotePopup(),this.mouseupHandler&&document.removeEventListener("mouseup",this.mouseupHandler),this.clickHandler&&document.removeEventListener("click",this.clickHandler)}}"undefined"!=typeof window&&(window.HighlightManager=HighlightManager,window.highlightManager=new HighlightManager);