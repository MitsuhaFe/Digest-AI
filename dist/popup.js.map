{"version":3,"file":"popup.js","mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://digest-ai-extension/./popup.js"],"sourcesContent":["/**\n * Popup 界面逻辑\n * 处理用户交互和状态管理\n */\n\n/**\n * 安全地发送消息给 background service worker\n * 包含重试逻辑以处理 service worker 未就绪的情况\n */\nasync function sendMessageSafely(message, retries = 3, delay = 100) {\n  for (let i = 0; i < retries; i++) {\n    try {\n      const response = await chrome.runtime.sendMessage(message);\n      return response;\n    } catch (error) {\n      // 检查是否是 \"Receiving end does not exist\" 错误\n      if (error.message.includes('Receiving end does not exist')) {\n        console.warn(`Service worker 未就绪，重试 ${i + 1}/${retries}...`);\n        \n        if (i < retries - 1) {\n          // 等待一段时间后重试\n          await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));\n          continue;\n        }\n      }\n      \n      // 其他错误或最后一次重试失败，抛出错误\n      throw error;\n    }\n  }\n  \n  throw new Error('无法连接到扩展后台服务，请重新加载扩展');\n}\n\n// 状态管理\nconst STATE = {\n  IDLE: 'idle',\n  PROCESSING: 'processing',\n  SUCCESS: 'success',\n  ERROR: 'error',\n  NO_CONFIG: 'noConfig'\n};\n\nlet currentState = STATE.IDLE;\nlet currentArticle = null;\nlet currentTags = [];\n\n// DOM 元素\nconst elements = {\n  // 状态元素\n  idleState: document.getElementById('idleState'),\n  processingState: document.getElementById('processingState'),\n  successState: document.getElementById('successState'),\n  errorState: document.getElementById('errorState'),\n  noConfigState: document.getElementById('noConfigState'),\n  \n  // 按钮\n  saveBtn: document.getElementById('saveBtn'),\n  settingsBtn: document.getElementById('settingsBtn'),\n  viewLibraryBtn: document.getElementById('viewLibraryBtn'),\n  closeBtn: document.getElementById('closeBtn'),\n  retryBtn: document.getElementById('retryBtn'),\n  goToSettingsBtn: document.getElementById('goToSettingsBtn'),\n  viewAllLink: document.getElementById('viewAllLink'),\n  \n  // 信息显示\n  processingDetail: document.getElementById('processingDetail'),\n  errorMessage: document.getElementById('errorMessage'),\n  articleTitle: document.getElementById('articleTitle'),\n  articleUrl: document.getElementById('articleUrl'),\n  \n  // 保存选项\n  saveOriginalCheckbox: document.getElementById('saveOriginalCheckbox'),\n  saveImagesCheckbox: document.getElementById('saveImagesCheckbox'),\n  \n  // 标签相关\n  tagInput: document.getElementById('tagInput'),\n  tagList: document.getElementById('tagList'),\n  suggestedTagsArea: document.getElementById('suggestedTagsArea'),\n  suggestedTagsList: document.getElementById('suggestedTagsList')\n};\n\n/**\n * 切换状态显示\n */\nfunction setState(state) {\n  // 隐藏所有状态\n  Object.values(elements).forEach(el => {\n    if (el && el.classList && el.classList.contains('state')) {\n      el.classList.add('hidden');\n    }\n  });\n  \n  // 显示当前状态\n  currentState = state;\n  switch (state) {\n    case STATE.IDLE:\n      elements.idleState.classList.remove('hidden');\n      break;\n    case STATE.PROCESSING:\n      elements.processingState.classList.remove('hidden');\n      break;\n    case STATE.SUCCESS:\n      elements.successState.classList.remove('hidden');\n      break;\n    case STATE.ERROR:\n      elements.errorState.classList.remove('hidden');\n      break;\n    case STATE.NO_CONFIG:\n      elements.noConfigState.classList.remove('hidden');\n      break;\n  }\n}\n\n/**\n * 检查配置是否完整\n */\nasync function checkConfiguration() {\n  try {\n    const result = await chrome.storage.local.get([\n      'aiModel',\n      'apiKey', // 旧版本兼容\n      'geminiApiKey',\n      'openaiApiKey',\n      'claudeApiKey',\n      'deepseekApiKey',\n      'qwenApiKey'\n    ]);\n    \n    if (!result.aiModel) {\n      return false;\n    }\n    \n    // 根据选择的模型检查对应的 API Key\n    const apiKeyMap = {\n      'gemini': result.geminiApiKey,\n      'openai': result.openaiApiKey,\n      'claude': result.claudeApiKey,\n      'deepseek': result.deepseekApiKey,\n      'qwen': result.qwenApiKey\n    };\n    \n    const modelApiKey = apiKeyMap[result.aiModel];\n    \n    // 向后兼容：如果新 key 不存在，检查旧的 apiKey\n    return !!(modelApiKey || result.apiKey);\n  } catch (error) {\n    console.error('检查配置失败:', error);\n    return false;\n  }\n}\n\n/**\n * 保存文章\n */\nasync function saveArticle() {\n  // 检查配置\n  const hasConfig = await checkConfiguration();\n  if (!hasConfig) {\n    setState(STATE.NO_CONFIG);\n    return;\n  }\n  \n  setState(STATE.PROCESSING);\n  \n  try {\n    // 获取当前活动标签页\n    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });\n    \n    if (!tab || !tab.id) {\n      throw new Error('无法获取当前标签页');\n    }\n    \n    // 根据 URL 判断内容类型，显示不同的提示\n    const url = tab.url || '';\n    let processingText = '提取内容中...';\n    \n    if (url.endsWith('.pdf') || url.includes('.pdf')) {\n      processingText = '提取 PDF 文档内容中...';\n    } else if (url.includes('bilibili.com/video/')) {\n      processingText = '提取 Bilibili 视频内容中...';\n    } else if (url.includes('youtube.com/watch') || url.includes('youtu.be/')) {\n      processingText = '提取 YouTube 视频内容中...';\n    } else {\n      processingText = '提取文章内容中...';\n    }\n    \n    elements.processingDetail.textContent = processingText;\n    \n    // 获取用户选择的保存选项\n    const saveOriginalContent = elements.saveOriginalCheckbox.checked;\n    const saveImages = elements.saveImagesCheckbox.checked;\n    \n    // 向 background.js 发送保存请求（使用安全发送函数）\n    const response = await sendMessageSafely({\n      action: 'saveArticle',\n      tabId: tab.id,\n      url: tab.url,\n      title: tab.title,\n      saveOriginalContent: saveOriginalContent,\n      saveImages: saveImages\n    });\n    \n    if (response.success) {\n      currentArticle = response.article;\n      currentTags = response.article.tags || [];\n      showSuccess();\n    } else {\n      throw new Error(response.error || '保存失败');\n    }\n  } catch (error) {\n    console.error('保存文章失败:', error);\n    showError(error.message);\n  }\n}\n\n/**\n * 显示成功状态\n */\nfunction showSuccess() {\n  setState(STATE.SUCCESS);\n  \n  if (currentArticle) {\n    elements.articleTitle.textContent = currentArticle.title;\n    elements.articleUrl.textContent = currentArticle.url;\n    renderTags();\n    renderSuggestedTags();\n  }\n}\n\n/**\n * 渲染 AI 推荐标签\n */\nfunction renderSuggestedTags() {\n  if (!currentArticle || !currentArticle.suggestedTags || currentArticle.suggestedTags.length === 0) {\n    elements.suggestedTagsArea.classList.add('hidden');\n    return;\n  }\n  \n  elements.suggestedTagsArea.classList.remove('hidden');\n  elements.suggestedTagsList.innerHTML = '';\n  \n  currentArticle.suggestedTags.forEach(tag => {\n    // 如果标签已被添加，不显示\n    if (currentTags.includes(tag)) {\n      return;\n    }\n    \n    const tagEl = document.createElement('button');\n    tagEl.className = 'suggested-tag';\n    tagEl.textContent = tag;\n    tagEl.dataset.tag = tag;\n    elements.suggestedTagsList.appendChild(tagEl);\n  });\n}\n\n/**\n * 显示错误状态\n */\nfunction showError(message) {\n  setState(STATE.ERROR);\n  elements.errorMessage.textContent = message || '发生未知错误';\n}\n\n/**\n * 渲染标签列表\n */\nfunction renderTags() {\n  elements.tagList.innerHTML = '';\n  \n  currentTags.forEach(tag => {\n    const tagEl = document.createElement('span');\n    tagEl.className = 'tag';\n    tagEl.innerHTML = `\n      ${tag}\n      <span class=\"tag-remove\" data-tag=\"${tag}\">×</span>\n    `;\n    elements.tagList.appendChild(tagEl);\n  });\n}\n\n/**\n * 添加标签\n */\nasync function addTag(tag) {\n  tag = tag.trim();\n  if (!tag || currentTags.includes(tag)) {\n    return;\n  }\n  \n  currentTags.push(tag);\n  \n  // 更新存储\n  if (currentArticle) {\n    try {\n      await sendMessageSafely({\n        action: 'updateArticleTags',\n        articleId: currentArticle.id,\n        tags: currentTags\n      });\n      renderTags();\n      renderSuggestedTags(); // 重新渲染推荐标签（移除已添加的）\n      elements.tagInput.value = '';\n    } catch (error) {\n      console.error('添加标签失败:', error);\n    }\n  }\n}\n\n/**\n * 删除标签\n */\nasync function removeTag(tag) {\n  currentTags = currentTags.filter(t => t !== tag);\n  \n  // 更新存储\n  if (currentArticle) {\n    try {\n      await sendMessageSafely({\n        action: 'updateArticleTags',\n        articleId: currentArticle.id,\n        tags: currentTags\n      });\n      renderTags();\n      renderSuggestedTags(); // 重新渲染推荐标签（可能重新显示）\n    } catch (error) {\n      console.error('删除标签失败:', error);\n    }\n  }\n}\n\n/**\n * 打开阅读库\n */\nfunction openDashboard() {\n  chrome.tabs.create({ url: 'dashboard.html' });\n  window.close();\n}\n\n/**\n * 打开设置\n */\nfunction openSettings() {\n  chrome.tabs.create({ url: 'settings.html' });\n  window.close();\n}\n\n// 事件监听器\nelements.saveBtn.addEventListener('click', saveArticle);\nelements.retryBtn.addEventListener('click', saveArticle);\nelements.settingsBtn.addEventListener('click', openSettings);\nelements.goToSettingsBtn.addEventListener('click', openSettings);\nelements.viewLibraryBtn.addEventListener('click', openDashboard);\nelements.viewAllLink.addEventListener('click', (e) => {\n  e.preventDefault();\n  openDashboard();\n});\nelements.closeBtn.addEventListener('click', () => window.close());\n\n// 标签输入处理\nelements.tagInput.addEventListener('keypress', (e) => {\n  if (e.key === 'Enter') {\n    addTag(e.target.value);\n  }\n});\n\n// 标签删除处理\nelements.tagList.addEventListener('click', (e) => {\n  if (e.target.classList.contains('tag-remove')) {\n    const tag = e.target.dataset.tag;\n    removeTag(tag);\n  }\n});\n\n// AI 推荐标签点击处理\nelements.suggestedTagsList.addEventListener('click', (e) => {\n  if (e.target.classList.contains('suggested-tag')) {\n    const tag = e.target.dataset.tag;\n    addTag(tag);\n  }\n});\n\n/**\n * 加载保存选项默认值\n */\nasync function loadSaveOptions() {\n  try {\n    const settings = await chrome.storage.local.get(['saveOriginalContent', 'saveImages']);\n    \n    // 设置复选框状态（默认都勾选）\n    elements.saveOriginalCheckbox.checked = settings.saveOriginalContent !== undefined ? settings.saveOriginalContent : true;\n    elements.saveImagesCheckbox.checked = settings.saveImages !== undefined ? settings.saveImages : true;\n  } catch (error) {\n    console.error('加载保存选项失败:', error);\n    // 使用默认值\n    elements.saveOriginalCheckbox.checked = true;\n    elements.saveImagesCheckbox.checked = true;\n  }\n}\n\n// 初始化\n(async function init() {\n  // 加载保存选项默认值\n  await loadSaveOptions();\n  \n  const hasConfig = await checkConfiguration();\n  if (!hasConfig) {\n    setState(STATE.NO_CONFIG);\n  } else {\n    setState(STATE.IDLE);\n  }\n})();\n\n"],"names":[],"sourceRoot":""}