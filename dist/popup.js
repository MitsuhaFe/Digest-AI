(()=>{async function e(e,t=3,n=100){for(let s=0;s<t;s++)try{return await chrome.runtime.sendMessage(e)}catch(e){if(e.message.includes("Receiving end does not exist")&&(console.warn(`Service worker 未就绪，重试 ${s+1}/${t}...`),s<t-1)){await new Promise(e=>setTimeout(e,n*(s+1)));continue}throw e}throw new Error("无法连接到扩展后台服务，请重新加载扩展")}const t="idle",n="processing",s="success",a="error",i="noConfig";let c=t,r=null,o=[];const d={idleState:document.getElementById("idleState"),processingState:document.getElementById("processingState"),successState:document.getElementById("successState"),errorState:document.getElementById("errorState"),noConfigState:document.getElementById("noConfigState"),saveBtn:document.getElementById("saveBtn"),settingsBtn:document.getElementById("settingsBtn"),viewLibraryBtn:document.getElementById("viewLibraryBtn"),closeBtn:document.getElementById("closeBtn"),retryBtn:document.getElementById("retryBtn"),goToSettingsBtn:document.getElementById("goToSettingsBtn"),viewAllLink:document.getElementById("viewAllLink"),processingDetail:document.getElementById("processingDetail"),errorMessage:document.getElementById("errorMessage"),articleTitle:document.getElementById("articleTitle"),articleUrl:document.getElementById("articleUrl"),saveOriginalCheckbox:document.getElementById("saveOriginalCheckbox"),saveImagesCheckbox:document.getElementById("saveImagesCheckbox"),tagInput:document.getElementById("tagInput"),tagList:document.getElementById("tagList"),suggestedTagsArea:document.getElementById("suggestedTagsArea"),suggestedTagsList:document.getElementById("suggestedTagsList")};function l(e){switch(Object.values(d).forEach(e=>{e&&e.classList&&e.classList.contains("state")&&e.classList.add("hidden")}),c=e,e){case t:d.idleState.classList.remove("hidden");break;case n:d.processingState.classList.remove("hidden");break;case s:d.successState.classList.remove("hidden");break;case a:d.errorState.classList.remove("hidden");break;case i:d.noConfigState.classList.remove("hidden")}}async function g(){try{const e=await chrome.storage.local.get(["aiModel","apiKey","geminiApiKey","openaiApiKey","claudeApiKey","deepseekApiKey","qwenApiKey"]);if(!e.aiModel)return!1;return!(!{gemini:e.geminiApiKey,openai:e.openaiApiKey,claude:e.claudeApiKey,deepseek:e.deepseekApiKey,qwen:e.qwenApiKey}[e.aiModel]&&!e.apiKey)}catch(e){return console.error("检查配置失败:",e),!1}}async function u(){if(await g()){l(n);try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t||!t.id)throw new Error("无法获取当前标签页");const n=t.url||"";let a="提取内容中...";a=n.endsWith(".pdf")||n.includes(".pdf")?"提取 PDF 文档内容中...":n.includes("bilibili.com/video/")?"提取 Bilibili 视频内容中...":n.includes("youtube.com/watch")||n.includes("youtu.be/")?"提取 YouTube 视频内容中...":"提取文章内容中...",d.processingDetail.textContent=a;const i=d.saveOriginalCheckbox.checked,c=d.saveImagesCheckbox.checked,g=await e({action:"saveArticle",tabId:t.id,url:t.url,title:t.title,saveOriginalContent:i,saveImages:c});if(!g.success)throw new Error(g.error||"保存失败");r=g.article,o=g.article.tags||[],l(s),r&&(d.articleTitle.textContent=r.title,d.articleUrl.textContent=r.url,y(),m())}catch(e){console.error("保存文章失败:",e),t=e.message,l(a),d.errorMessage.textContent=t||"发生未知错误"}var t}else l(i)}function m(){r&&r.suggestedTags&&0!==r.suggestedTags.length?(d.suggestedTagsArea.classList.remove("hidden"),d.suggestedTagsList.innerHTML="",r.suggestedTags.forEach(e=>{if(o.includes(e))return;const t=document.createElement("button");t.className="suggested-tag",t.textContent=e,t.dataset.tag=e,d.suggestedTagsList.appendChild(t)})):d.suggestedTagsArea.classList.add("hidden")}function y(){d.tagList.innerHTML="",o.forEach(e=>{const t=document.createElement("span");t.className="tag",t.innerHTML=`\n      ${e}\n      <span class="tag-remove" data-tag="${e}">×</span>\n    `,d.tagList.appendChild(t)})}async function v(t){if((t=t.trim())&&!o.includes(t)&&(o.push(t),r))try{await e({action:"updateArticleTags",articleId:r.id,tags:o}),y(),m(),d.tagInput.value=""}catch(e){console.error("添加标签失败:",e)}}function h(){chrome.tabs.create({url:"dashboard.html"}),window.close()}function p(){chrome.tabs.create({url:"settings.html"}),window.close()}d.saveBtn.addEventListener("click",u),d.retryBtn.addEventListener("click",u),d.settingsBtn.addEventListener("click",p),d.goToSettingsBtn.addEventListener("click",p),d.viewLibraryBtn.addEventListener("click",h),d.viewAllLink.addEventListener("click",e=>{e.preventDefault(),h()}),d.closeBtn.addEventListener("click",()=>window.close()),d.tagInput.addEventListener("keypress",e=>{"Enter"===e.key&&v(e.target.value)}),d.tagList.addEventListener("click",t=>{t.target.classList.contains("tag-remove")&&async function(t){if(o=o.filter(e=>e!==t),r)try{await e({action:"updateArticleTags",articleId:r.id,tags:o}),y(),m()}catch(e){console.error("删除标签失败:",e)}}(t.target.dataset.tag)}),d.suggestedTagsList.addEventListener("click",e=>{e.target.classList.contains("suggested-tag")&&v(e.target.dataset.tag)}),async function(){await async function(){try{const e=await chrome.storage.local.get(["saveOriginalContent","saveImages"]);d.saveOriginalCheckbox.checked=void 0===e.saveOriginalContent||e.saveOriginalContent,d.saveImagesCheckbox.checked=void 0===e.saveImages||e.saveImages}catch(e){console.error("加载保存选项失败:",e),d.saveOriginalCheckbox.checked=!0,d.saveImagesCheckbox.checked=!0}}(),l(await g()?t:i)}()})();