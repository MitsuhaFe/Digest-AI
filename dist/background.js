(()=>{const e='è¯·åˆ†æä»¥ä¸‹æ–‡ç« å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªçº¦ {{SUMMARY_LENGTH}} å­—çš„ç®€æ´ä¸­æ–‡æ‘˜è¦ã€{{TAG_COUNT}} ä¸ªæ ¸å¿ƒè§‚ç‚¹å’Œ {{TAG_COUNT}} ä¸ªç›¸å…³æ ‡ç­¾ã€‚\n\nè¯·æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ç»“æœï¼š\n{\n  "summary": "æ–‡ç« æ‘˜è¦å†…å®¹...",\n  "keyPoints": [\n    "æ ¸å¿ƒè§‚ç‚¹1",\n    "æ ¸å¿ƒè§‚ç‚¹2",\n    "æ ¸å¿ƒè§‚ç‚¹3"\n  ],\n  "tags": [\n    "æ ‡ç­¾1",\n    "æ ‡ç­¾2",\n    "æ ‡ç­¾3"\n  ]\n}\n\næ–‡ç« å†…å®¹ï¼š\n{{TEXT}}\n\nè¯·ç›´æ¥è¿”å› JSON æ ¼å¼çš„ç»“æœï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ã€‚';class t{constructor(e,t={}){this.apiKey=e,this.modelName="gemini-2.5-flash",this.config={summaryLength:t.summaryLength||200,tagCount:t.tagCount||3,enableAutoTags:!1!==t.enableAutoTags,customPrompt:t.customPrompt||null,enableCustomPrompt:t.enableCustomPrompt||!1}}getEndpoint(){return`https://generativelanguage.googleapis.com/v1beta/models/${this.modelName}:generateContent?key=${this.apiKey}`}getHeaders(){return{"Content-Type":"application/json"}}generatePrompt(t){return(this.config.enableCustomPrompt&&this.config.customPrompt?this.config.customPrompt:e).replace(/\{\{TEXT\}\}/g,t.substring(0,8e3)).replace(/\{\{SUMMARY_LENGTH\}\}/g,this.config.summaryLength).replace(/\{\{TAG_COUNT\}\}/g,this.config.tagCount)}buildRequestBody(e){return{contents:[{parts:[{text:this.generatePrompt(e)}]}],generationConfig:{temperature:.4,topK:32,topP:1,maxOutputTokens:8192}}}parseResponse(e){try{if(console.log("ğŸ” Gemini API åŸå§‹å“åº”:",JSON.stringify(e,null,2)),!e.candidates||0===e.candidates.length)throw console.error("âŒ æ²¡æœ‰å€™é€‰ç»“æœ:",e),new Error("API è¿”å›äº†ç©ºç»“æœ");const t=e.candidates[0];console.log("ğŸ” å€™é€‰ç»“æœå®Œæ•´ç»“æ„:",t),console.log("ğŸ” å€™é€‰ç»“æœçš„æ‰€æœ‰é”®:",Object.keys(t)),t.content&&(console.log("ğŸ” content å†…å®¹:",t.content),console.log("ğŸ” content çš„é”®:",Object.keys(t.content)));let o="";if(t.content&&t.content.parts&&t.content.parts.length>0){console.log("ğŸ” æ‰¾åˆ° parts æ•°ç»„ï¼Œé•¿åº¦:",t.content.parts.length);for(let e=0;e<t.content.parts.length;e++){const s=t.content.parts[e];if(console.log(`ğŸ” æ£€æŸ¥ part[${e}]:`,s),s.text){o=s.text,console.log(`âœ… åœ¨ parts[${e}] ä¸­æ‰¾åˆ°æ–‡æœ¬:`,o.substring(0,100));break}}}if(!o&&t.text&&(o=t.text,console.log("âœ… ä½¿ç”¨ç›´æ¥æ–‡æœ¬æ ¼å¼")),!o&&t.message&&t.message.content&&(o=t.message.content,console.log("âœ… ä½¿ç”¨æ¶ˆæ¯æ ¼å¼")),!o&&t.output&&(o=t.output,console.log("âœ… ä½¿ç”¨ output å­—æ®µ")),!o&&t.content&&"string"==typeof t.content&&(o=t.content,console.log("âœ… content æœ¬èº«æ˜¯å­—ç¬¦ä¸²")),!o)throw console.error("âŒ æ— æ³•æ‰¾åˆ°æ–‡æœ¬å†…å®¹"),console.error("å€™é€‰å®Œæ•´å¯¹è±¡:",JSON.stringify(t,null,2)),new Error("API è¿”å›æ ¼å¼é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°æ–‡æœ¬å†…å®¹ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚");if(console.log("ğŸ“ æå–çš„æ–‡æœ¬:",o),!o)throw new Error("API è¿”å›çš„æ–‡æœ¬å†…å®¹ä¸ºç©º");const s=this.extractJSON(o);return console.log("ğŸ“Š è§£æçš„JSONç»“æœ:",s),{summary:s.summary||"",keyPoints:s.keyPoints||[],suggestedTags:this.config.enableAutoTags&&s.tags||[]}}catch(t){throw console.error("âŒ è§£æ Gemini å“åº”å¤±è´¥:",t),console.error("âŒ åŸå§‹æ•°æ®:",e),new Error("è§£æ AI å“åº”å¤±è´¥: "+t.message)}}extractJSON(e){try{return JSON.parse(e)}catch(t){const o=e.match(/```json\s*([\s\S]*?)\s*```/);if(o)return JSON.parse(o[1]);const s=e.match(/\{[\s\S]*\}/);if(s)return JSON.parse(s[0]);throw new Error("æ— æ³•ä»å“åº”ä¸­æå– JSON")}}async generateSummary(e){const t=this.getEndpoint(),o=this.buildRequestBody(e),s=this.getHeaders();try{const e=await fetch(t,{method:"POST",headers:s,body:JSON.stringify(o)});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(`Gemini API è¯·æ±‚å¤±è´¥: ${e.status} - ${t.error?.message||e.statusText}`)}const n=await e.json();return this.parseResponse(n)}catch(e){throw console.error("Gemini API è°ƒç”¨å¤±è´¥:",e),e}}}class o{constructor(e,t={}){this.apiKey=e,this.modelName="gpt-3.5-turbo",this.config={summaryLength:t.summaryLength||200,tagCount:t.tagCount||3,enableAutoTags:!1!==t.enableAutoTags,customPrompt:t.customPrompt||null,enableCustomPrompt:t.enableCustomPrompt||!1}}getEndpoint(){return"https://api.openai.com/v1/chat/completions"}getHeaders(){return{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`}}generatePrompt(t){return(this.config.enableCustomPrompt&&this.config.customPrompt?this.config.customPrompt:e).replace(/\{\{TEXT\}\}/g,t.substring(0,8e3)).replace(/\{\{SUMMARY_LENGTH\}\}/g,this.config.summaryLength).replace(/\{\{TAG_COUNT\}\}/g,this.config.tagCount)}buildRequestBody(e){const t=this.generatePrompt(e),o=this.config.enableAutoTags?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ï¼Œå¹¶èƒ½æ¨èç›¸å…³æ ‡ç­¾ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚";return{model:this.modelName,messages:[{role:"system",content:o},{role:"user",content:t}],temperature:.4,max_tokens:1024,response_format:{type:"json_object"}}}parseResponse(e){try{if(!e.choices||0===e.choices.length)throw new Error("API è¿”å›äº†ç©ºç»“æœ");const t=e.choices[0];if(!t.message||!t.message.content)throw new Error("API è¿”å›æ ¼å¼é”™è¯¯");const o=JSON.parse(t.message.content);return{summary:o.summary||"",keyPoints:o.keyPoints||[],suggestedTags:this.config.enableAutoTags&&o.tags||[]}}catch(e){throw console.error("è§£æ OpenAI å“åº”å¤±è´¥:",e),new Error("è§£æ AI å“åº”å¤±è´¥: "+e.message)}}async generateSummary(e){const t=this.getEndpoint(),o=this.buildRequestBody(e),s=this.getHeaders();try{const e=await fetch(t,{method:"POST",headers:s,body:JSON.stringify(o)});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(`OpenAI API è¯·æ±‚å¤±è´¥: ${e.status} - ${t.error?.message||e.statusText}`)}const n=await e.json();return this.parseResponse(n)}catch(e){throw console.error("OpenAI API è°ƒç”¨å¤±è´¥:",e),e}}}class s{constructor(e,t={}){this.apiKey=e,this.modelName="claude-3-haiku-20240307",this.config={summaryLength:t.summaryLength||200,tagCount:t.tagCount||3,enableAutoTags:!1!==t.enableAutoTags,customPrompt:t.customPrompt||null,enableCustomPrompt:t.enableCustomPrompt||!1}}getEndpoint(){return"https://api.anthropic.com/v1/messages"}getHeaders(){return{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"}}generatePrompt(t){return(this.config.enableCustomPrompt&&this.config.customPrompt?this.config.customPrompt:e).replace(/\{\{TEXT\}\}/g,t.substring(0,8e3)).replace(/\{\{SUMMARY_LENGTH\}\}/g,this.config.summaryLength).replace(/\{\{TAG_COUNT\}\}/g,this.config.tagCount)}buildRequestBody(e){const t=this.generatePrompt(e);return{model:this.modelName,max_tokens:1024,temperature:.4,messages:[{role:"user",content:t}]}}parseResponse(e){try{if(!e.content||0===e.content.length)throw new Error("API è¿”å›äº†ç©ºç»“æœ");const t=e.content[0];if(!t.text)throw new Error("API è¿”å›æ ¼å¼é”™è¯¯");const o=t.text,s=this.extractJSON(o);return{summary:s.summary||"",keyPoints:s.keyPoints||[],suggestedTags:this.config.enableAutoTags&&s.tags||[]}}catch(e){throw console.error("è§£æ Claude å“åº”å¤±è´¥:",e),new Error("è§£æ AI å“åº”å¤±è´¥: "+e.message)}}extractJSON(e){try{return JSON.parse(e)}catch(t){const o=e.match(/```json\s*([\s\S]*?)\s*```/);if(o)return JSON.parse(o[1]);const s=e.match(/\{[\s\S]*\}/);if(s)return JSON.parse(s[0]);throw new Error("æ— æ³•ä»å“åº”ä¸­æå– JSON")}}async generateSummary(e){const t=this.getEndpoint(),o=this.buildRequestBody(e),s=this.getHeaders();try{const e=await fetch(t,{method:"POST",headers:s,body:JSON.stringify(o)});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(`Claude API è¯·æ±‚å¤±è´¥: ${e.status} - ${t.error?.message||e.statusText}`)}const n=await e.json();return this.parseResponse(n)}catch(e){throw console.error("Claude API è°ƒç”¨å¤±è´¥:",e),e}}}class n{constructor(e,t={}){this.apiKey=e,this.modelName="qwen-plus",this.config={summaryLength:t.summaryLength||200,tagCount:t.tagCount||3,enableAutoTags:!1!==t.enableAutoTags,customPrompt:t.customPrompt||null,enableCustomPrompt:t.enableCustomPrompt||!1}}getEndpoint(){return"https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"}getHeaders(){return{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`}}generatePrompt(t){return(this.config.enableCustomPrompt&&this.config.customPrompt?this.config.customPrompt:e).replace(/\{\{TEXT\}\}/g,t.substring(0,8e3)).replace(/\{\{SUMMARY_LENGTH\}\}/g,this.config.summaryLength).replace(/\{\{TAG_COUNT\}\}/g,this.config.tagCount)}buildRequestBody(e){const t=this.generatePrompt(e),o=this.config.enableAutoTags?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ï¼Œå¹¶èƒ½æ¨èç›¸å…³æ ‡ç­¾ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚";return{model:this.modelName,input:{messages:[{role:"system",content:o},{role:"user",content:t}]},parameters:{temperature:.4,max_tokens:1024,result_format:"message"}}}parseResponse(e){try{if(!e.output||!e.output.choices||0===e.output.choices.length)throw new Error("API è¿”å›äº†ç©ºç»“æœ");const t=e.output.choices[0];if(!t.message||!t.message.content)throw new Error("API è¿”å›æ ¼å¼é”™è¯¯");const o=t.message.content,s=this.extractJSON(o);return{summary:s.summary||"",keyPoints:s.keyPoints||[],suggestedTags:this.config.enableAutoTags&&s.tags||[]}}catch(e){throw console.error("è§£æé€šä¹‰åƒé—®å“åº”å¤±è´¥:",e),new Error("è§£æ AI å“åº”å¤±è´¥: "+e.message)}}extractJSON(e){try{return JSON.parse(e)}catch(t){const o=e.match(/```json\s*([\s\S]*?)\s*```/);if(o)return JSON.parse(o[1]);const s=e.match(/\{[\s\S]*\}/);if(s)return JSON.parse(s[0]);throw new Error("æ— æ³•ä»å“åº”ä¸­æå– JSON")}}async generateSummary(e){const t=this.getEndpoint(),o=this.buildRequestBody(e),s=this.getHeaders();try{const e=await fetch(t,{method:"POST",headers:s,body:JSON.stringify(o)});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(`é€šä¹‰åƒé—® API è¯·æ±‚å¤±è´¥: ${e.status} - ${t.message||e.statusText}`)}const n=await e.json();return this.parseResponse(n)}catch(e){throw console.error("é€šä¹‰åƒé—® API è°ƒç”¨å¤±è´¥:",e),e}}}class r{constructor(e,t={}){this.apiKey=e,this.modelName="deepseek-chat",this.config={summaryLength:t.summaryLength||200,tagCount:t.tagCount||3,enableAutoTags:!1!==t.enableAutoTags,customPrompt:t.customPrompt||null,enableCustomPrompt:t.enableCustomPrompt||!1}}getEndpoint(){return"https://api.deepseek.com/v1/chat/completions"}getHeaders(){return{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`}}generatePrompt(t){return(this.config.enableCustomPrompt&&this.config.customPrompt?this.config.customPrompt:e).replace(/\{\{TEXT\}\}/g,t.substring(0,8e3)).replace(/\{\{SUMMARY_LENGTH\}\}/g,this.config.summaryLength).replace(/\{\{TAG_COUNT\}\}/g,this.config.tagCount)}buildRequestBody(e){const t=this.generatePrompt(e),o=this.config.enableAutoTags?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ï¼Œå¹¶èƒ½æ¨èç›¸å…³æ ‡ç­¾ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ç« æ‘˜è¦åŠ©æ‰‹ï¼Œæ“…é•¿æå–æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œå…³é”®è§‚ç‚¹ã€‚è¯·å§‹ç»ˆç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ JSON æ ¼å¼è¿”å›ç»“æœã€‚";return{model:this.modelName,messages:[{role:"system",content:o},{role:"user",content:t}],temperature:.4,max_tokens:1024}}parseResponse(e){try{if(!e.choices||0===e.choices.length)throw new Error("API è¿”å›äº†ç©ºç»“æœ");const t=e.choices[0];if(!t.message||!t.message.content)throw new Error("API è¿”å›æ ¼å¼é”™è¯¯");const o=t.message.content,s=this.extractJSON(o);return{summary:s.summary||"",keyPoints:s.keyPoints||[],suggestedTags:this.config.enableAutoTags&&s.tags||[]}}catch(e){throw console.error("è§£æ DeepSeek å“åº”å¤±è´¥:",e),new Error("è§£æ AI å“åº”å¤±è´¥: "+e.message)}}extractJSON(e){try{return JSON.parse(e)}catch(t){const o=e.match(/```json\s*([\s\S]*?)\s*```/);if(o)return JSON.parse(o[1]);const s=e.match(/\{[\s\S]*\}/);if(s)return JSON.parse(s[0]);throw new Error("æ— æ³•ä»å“åº”ä¸­æå– JSON")}}async generateSummary(e){const t=this.getEndpoint(),o=this.buildRequestBody(e),s=this.getHeaders();try{const e=await fetch(t,{method:"POST",headers:s,body:JSON.stringify(o)});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(`DeepSeek API è¯·æ±‚å¤±è´¥: ${e.status} - ${t.error?.message||e.statusText}`)}const n=await e.json();return this.parseResponse(n)}catch(e){throw console.error("DeepSeek API è°ƒç”¨å¤±è´¥:",e),e}}}async function a(){try{return(await chrome.storage.local.get(["articles"])).articles||[]}catch(e){return console.error("è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:",e),[]}}chrome.runtime.onMessage.addListener((e,c,i)=>{if(console.log("ğŸ“¬ Background æ”¶åˆ°æ¶ˆæ¯:",e.action||e),"saveArticle"===e.action){const u=e.tabId||c.tab?.id;return u?(console.log("ä¿å­˜æ–‡ç« è¯·æ±‚ - æ¥æº:",c.tab?"content script":"popup","tabId:",u,"url:",e.url),console.log("ä¿å­˜é€‰é¡¹ - åŸæ–‡:",e.saveOriginalContent,"å›¾ç‰‡:",e.saveImages),async function(e,c,i,u,g){try{const m=await chrome.tabs.sendMessage(e,{action:"extractContent"});if(!m.success)throw new Error(m.error||"æå–å†…å®¹å¤±è´¥");const l=m.content,h=await chrome.storage.local.get(["aiModel","apiKey","geminiApiKey","openaiApiKey","claudeApiKey","deepseekApiKey","qwenApiKey","summaryLength","tagCount","enableAutoTags","enableCustomPrompt","customPrompt","saveOriginalContent","saveImages"]),p=void 0!==u?u:void 0===h.saveOriginalContent||h.saveOriginalContent,d=void 0!==g?g:void 0===h.saveImages||h.saveImages;if(console.log("æœ€ç»ˆä¿å­˜é€‰é¡¹ - åŸæ–‡:",p,"å›¾ç‰‡:",d),!h.aiModel)throw new Error("æœªé…ç½® AI æ¨¡å‹");let y={gemini:h.geminiApiKey,openai:h.openaiApiKey,claude:h.claudeApiKey,deepseek:h.deepseekApiKey,qwen:h.qwenApiKey}[h.aiModel];if(!y&&h.apiKey&&(y=h.apiKey,console.log("ä½¿ç”¨æ—§ç‰ˆ API Keyï¼ˆå‘åå…¼å®¹ï¼‰")),!y)throw new Error(`æœªé…ç½® ${{gemini:"Google Gemini",openai:"OpenAI",claude:"Anthropic Claude",deepseek:"DeepSeek",qwen:"é€šä¹‰åƒé—®"}[h.aiModel]||h.aiModel} çš„ API Keyï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢é…ç½®`);const w={summaryLength:h.summaryLength||200,tagCount:h.tagCount||3,enableAutoTags:!1!==h.enableAutoTags,enableCustomPrompt:h.enableCustomPrompt||!1,customPrompt:h.customPrompt||null},f=l.type||"webpage",P=f.startsWith("video-");console.log("å†…å®¹ç±»å‹:",f);let A=l.htmlContent||"",b=l.content||"";P||(console.log("åŸå§‹HTMLé•¿åº¦:",A.length),!d&&A&&(A=A.replace(/<img[^>]*>/gi,""),A=A.replace(/<figure[^>]*>.*?<\/figure>/gi,""),console.log("ç§»é™¤å›¾ç‰‡åHTMLé•¿åº¦:",A.length)),p||(b="",A="",console.log("å·²æ¸…ç©ºåŸæ–‡å†…å®¹ï¼Œä»…ä¿å­˜æ‘˜è¦")));const T=function(e,a,c={}){switch(e){case"gemini":return new t(a,c);case"openai":return new o(a,c);case"claude":return new s(a,c);case"deepseek":return new r(a,c);case"qwen":return new n(a,c);default:throw new Error(`ä¸æ”¯æŒçš„æ¨¡å‹ç±»å‹: ${e}`)}}(h.aiModel,y,w),S=await T.generateSummary(b),O={id:Date.now().toString(36)+Math.random().toString(36).substr(2),type:f,title:l.title||i,url:c,source:l.siteName||l.videoInfo?.author||new URL(c).hostname,dateAdded:(new Date).toISOString(),content:b,htmlContent:A,excerpt:l.excerpt||"",summary:S.summary,keyPoints:S.keyPoints,tags:[],suggestedTags:S.suggestedTags||[],byline:l.byline||l.videoInfo?.author||"",hasOriginalContent:p};return P&&(O.videoMetadata={duration:l.metadata?.duration||0,author:l.metadata?.author||"",cover:l.metadata?.cover||"",pubdate:l.metadata?.pubdate||"",tags:l.metadata?.tags||[],stats:l.metadata?.stats||{},subtitles:l.subtitles||{available:!1},comments:l.comments||null},l.videoInfo?.description&&(O.excerpt=l.videoInfo.description.substring(0,300))),await async function(e){try{const t=await a();return t.unshift(e),await chrome.storage.local.set({articles:t}),!0}catch(e){throw console.error("ä¿å­˜æ–‡ç« å¤±è´¥:",e),e}}(O),{success:!0,article:O}}catch(e){return console.error("ä¿å­˜æ–‡ç« å¤±è´¥:",e),{success:!1,error:e.message}}}(u,e.url,e.title,e.saveOriginalContent,e.saveImages).then(e=>i(e)).catch(e=>i({success:!1,error:e.message})),!0):(console.error("æ— æ³•è·å– tabId"),i({success:!1,error:"æ— æ³•è·å–æ ‡ç­¾é¡µID"}),!0)}return"updateArticleTags"===e.action?(async function(e,t){try{const o=await a(),s=o.find(t=>t.id===e);return!!s&&(s.tags=t,await chrome.storage.local.set({articles:o}),!0)}catch(e){throw console.error("æ›´æ–°æ–‡ç« æ ‡ç­¾å¤±è´¥:",e),e}}(e.articleId,e.tags).then(()=>i({success:!0})).catch(e=>i({success:!1,error:e.message})),!0):"getArticles"===e.action?(a().then(e=>i({success:!0,articles:e})).catch(e=>i({success:!1,error:e.message})),!0):"deleteArticle"===e.action&&(a().then(async t=>{const o=t.filter(t=>t.id!==e.articleId);await chrome.storage.local.set({articles:o}),i({success:!0})}).catch(e=>i({success:!1,error:e.message})),!0)}),chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason?(console.log("Digest AI å·²å®‰è£…"),chrome.tabs.create({url:"settings.html"})):"update"===e.reason&&console.log("Digest AI å·²æ›´æ–°åˆ°ç‰ˆæœ¬:",chrome.runtime.getManifest().version)}),console.log("Background service worker å·²å¯åŠ¨")})();