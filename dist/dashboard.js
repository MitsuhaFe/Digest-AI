(()=>{let t=[],e=null,n=[],a=new Set;const i={articlesList:document.getElementById("articlesList"),emptyState:document.getElementById("emptyState"),searchInput:document.getElementById("searchInput"),tagFilter:document.getElementById("tagFilter"),settingsBtn:document.getElementById("settingsBtn"),themeToggleBtn:document.getElementById("themeToggleBtn"),welcomeView:document.getElementById("welcomeView"),articleView:document.getElementById("articleView"),articleTitle:document.getElementById("articleTitle"),articleSource:document.getElementById("articleSource"),articleDate:document.getElementById("articleDate"),articleSummary:document.getElementById("articleSummary"),articleKeyPoints:document.getElementById("articleKeyPoints"),articleBody:document.getElementById("articleBody"),articleTagsList:document.getElementById("articleTagsList"),metaSource:document.getElementById("metaSource"),metaDate:document.getElementById("metaDate"),metaUrl:document.getElementById("metaUrl"),metaLength:document.getElementById("metaLength"),openOriginalBtn:document.getElementById("openOriginalBtn"),exportMarkdownBtn:document.getElementById("exportMarkdownBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),addTagBtn:document.getElementById("addTagBtn"),tagModal:document.getElementById("tagModal"),newTagInput:document.getElementById("newTagInput"),confirmTagBtn:document.getElementById("confirmTagBtn"),cancelTagBtn:document.getElementById("cancelTagBtn")};async function o(){try{const e=await chrome.runtime.sendMessage({action:"getArticles"});e.success&&(t=e.articles||[],n=[...t],a.clear(),t.forEach(t=>{t.tags&&Array.isArray(t.tags)&&t.tags.forEach(t=>a.add(t))}),c(),s(),t.length>0&&r(t[0]))}catch(t){console.error("åŠ è½½æ–‡ç« å¤±è´¥:",t)}}function s(){const t=i.tagFilter.value;i.tagFilter.innerHTML='<option value="">æ‰€æœ‰æ ‡ç­¾</option>',Array.from(a).sort().forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,i.tagFilter.appendChild(e)}),t&&a.has(t)&&(i.tagFilter.value=t)}function c(){if(i.articlesList.innerHTML="",0===n.length)return i.emptyState.classList.remove("hidden"),void i.articlesList.classList.add("hidden");i.emptyState.classList.add("hidden"),i.articlesList.classList.remove("hidden"),n.forEach(t=>{const n=function(t){const n=document.createElement("div");n.className="article-item",n.dataset.id=t.id;const a=t.type&&t.type.startsWith("video-");a&&n.classList.add("video-item");const i=u(new Date(t.dateAdded)),o=a?"ğŸ¥ ":"",s=a&&t.videoMetadata?.duration?` â€¢ ${p(t.videoMetadata.duration)}`:"";return n.innerHTML=`\n    <div class="article-item-title">${o}${h(t.title)}</div>\n    <div class="article-item-meta">\n      <span class="article-item-source">${h(t.source)}</span>\n      <span>â€¢</span>\n      <span>${i}</span>\n      ${s?`<span>${s}</span>`:""}\n    </div>\n  `,n.addEventListener("click",()=>{r(t)}),e&&e.id===t.id&&n.classList.add("active"),n}(t);i.articlesList.appendChild(n)})}function r(t){e=t,document.querySelectorAll(".article-item").forEach(e=>{e.classList.remove("active"),e.dataset.id===t.id&&e.classList.add("active")}),function(t){i.welcomeView.classList.add("hidden"),i.articleView.classList.remove("hidden"),i.articleTitle.textContent=t.title,i.articleSource.textContent=t.source;const e=new Date(t.dateAdded);if(i.articleDate.textContent=u(e),i.articleSummary.textContent=t.summary||"æš‚æ— æ‘˜è¦",i.articleKeyPoints.innerHTML="",t.keyPoints&&t.keyPoints.length>0)t.keyPoints.forEach(t=>{const e=document.createElement("li");e.textContent=t,i.articleKeyPoints.appendChild(e)});else{const t=document.createElement("li");t.textContent="æš‚æ— æ ¸å¿ƒè§‚ç‚¹",i.articleKeyPoints.appendChild(t)}if(t.type&&t.type.startsWith("video-")){const e=t.videoMetadata||{},n=e.subtitles?.available,a=n?e.subtitles.fullText:"";i.articleBody.innerHTML=`\n      <div class="video-content-box">\n        <div class="video-header">\n          <h3>ğŸ¥ è§†é¢‘ä¿¡æ¯</h3>\n        </div>\n        \n        <div class="video-metadata">\n          ${e.duration?`<div class="meta-item"><strong>æ—¶é•¿:</strong> ${p(e.duration)}</div>`:""}\n          ${e.author?`<div class="meta-item"><strong>UPä¸»:</strong> ${h(e.author)}</div>`:""}\n          ${e.pubdate?`<div class="meta-item"><strong>å‘å¸ƒ:</strong> ${new Date(e.pubdate).toLocaleDateString("zh-CN")}</div>`:""}\n          ${e.stats?.view?`<div class="meta-item"><strong>æ’­æ”¾:</strong> ${e.stats.view.toLocaleString()}</div>`:""}\n          ${e.stats?.like?`<div class="meta-item"><strong>ç‚¹èµ:</strong> ${e.stats.like.toLocaleString()}</div>`:""}\n        </div>\n        \n        ${t.contentSources?`\n          <div class="content-sources">\n            <strong>ğŸ“Š å†…å®¹æ¥æºï¼š</strong>\n            <span class="source-tags">\n              ${t.contentSources.map(t=>`<span class="source-tag">${{å­—å¹•:"ğŸ“",çƒ­é—¨è¯„è®º:"ğŸ’¬",ç®€ä»‹:"ğŸ“„",æ ‡ç­¾:"ğŸ·ï¸",ç»Ÿè®¡:"ğŸ“Š"}[t]||"ğŸ“Œ"} ${t}</span>`).join("")}\n            </span>\n          </div>\n        `:""}\n        \n        ${n?`\n          <div class="video-subtitles">\n            <h4>ğŸ“ è§†é¢‘å­—å¹• ${"dom"===e.subtitles?.method?"(ä»é¡µé¢æå–)":""}</h4>\n            <div class="subtitle-text">${h(a)}</div>\n          </div>\n        `:e.comments?.available?`\n          <div class="video-comments">\n            <h4>ğŸ’¬ çƒ­é—¨è¯„è®º (${e.comments.count} æ¡ï¼Œæœ€é«˜ ${e.comments.topLikes} èµ)</h4>\n            <div class="comments-sample">\n              <p style="color: #666; font-size: 13px; margin-bottom: 10px;">\n                â„¹ï¸ ç”±äºè§†é¢‘æ²¡æœ‰å­—å¹•ï¼Œå·²æå–çƒ­é—¨è¯„è®ºä½œä¸ºå†…å®¹è¡¥å……\n              </p>\n              <div class="subtitle-text">${h(e.comments.sample)}</div>\n            </div>\n          </div>\n        `:`\n          <div class="no-subtitles">\n            <p>âš ï¸ æ­¤è§†é¢‘æ²¡æœ‰å­—å¹•</p>\n            <p style="color: #999; font-size: 14px;">${e.subtitles?.message||"å·²ç»¼åˆç®€ä»‹ã€æ ‡ç­¾ç­‰ä¿¡æ¯ç”Ÿæˆæ‘˜è¦"}</p>\n          </div>\n        `}\n        \n        ${t.excerpt?`\n          <div class="video-description">\n            <h4>ğŸ“„ è§†é¢‘ç®€ä»‹</h4>\n            <p>${h(t.excerpt)}</p>\n          </div>\n        `:""}\n        \n        <div class="video-actions">\n          <a href="${t.url}" target="_blank" class="video-link-btn">\n            ğŸ”— è§‚çœ‹è§†é¢‘\n          </a>\n        </div>\n      </div>\n    `}else t.htmlContent?i.articleBody.innerHTML=function(t){const e=document.createElement("div");return e.innerHTML=t,["script","iframe","object","embed","link"].forEach(t=>{e.querySelectorAll(t).forEach(t=>t.remove())}),e.innerHTML}(t.htmlContent):t.content?i.articleBody.textContent=t.content:!1===t.hasOriginalContent?i.articleBody.innerHTML=`\n      <div style="text-align: center; padding: 40px 20px; color: #666;">\n        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>\n        <p style="font-size: 16px; margin-bottom: 8px;">æ­¤æ–‡ç« æœªä¿å­˜åŸæ–‡å†…å®¹</p>\n        <p style="font-size: 14px; color: #999;">ä»…ä¿å­˜äº† AI ç”Ÿæˆçš„æ‘˜è¦å’Œå…³é”®è§‚ç‚¹</p>\n        <a href="${t.url}" target="_blank" style="display: inline-block; margin-top: 16px; padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 6px;">è®¿é—®åŸæ–‡é“¾æ¥</a>\n      </div>\n    `:i.articleBody.textContent="å†…å®¹ä¸å¯ç”¨";window.highlightManager&&window.highlightManager.init(t.id,i.articleBody,t.highlights||[]),l(t.tags||[]),i.metaSource.textContent=t.source,i.metaDate.textContent=new Date(t.dateAdded).toLocaleString("zh-CN"),i.metaUrl.href=t.url,i.metaUrl.textContent=t.url,i.metaLength.textContent=`${t.content?t.content.length:0} å­—`,i.articleView.parentElement.scrollTop=0}(t)}function l(t){i.articleTagsList.innerHTML="",t.forEach(t=>{const e=document.createElement("span");e.className="tag",e.innerHTML=`\n      ${h(t)}\n      <span class="tag-remove" data-tag="${h(t)}">Ã—</span>\n    `,i.articleTagsList.appendChild(e)})}function d(e){e=e.toLowerCase().trim(),n=e?t.filter(t=>{const n=t.title.toLowerCase().includes(e),a=t.content&&t.content.toLowerCase().includes(e),i=t.summary&&t.summary.toLowerCase().includes(e);return n||a||i}):[...t],function(){const t=i.tagFilter.value;t&&(n=n.filter(e=>e.tags&&e.tags.includes(t))),c()}()}async function m(t){if(!(t=t.trim())||!e)return;const n=e.tags||[];if(n.includes(t))showWarning("æ ‡ç­¾å·²å­˜åœ¨");else{n.push(t);try{await chrome.runtime.sendMessage({action:"updateArticleTags",articleId:e.id,tags:n}),e.tags=n,l(n),a.add(t),s(),g(),showSuccess(`æ ‡ç­¾"${t}"å·²æ·»åŠ `)}catch(t){console.error("æ·»åŠ æ ‡ç­¾å¤±è´¥:",t),showError("æ·»åŠ æ ‡ç­¾å¤±è´¥: "+t.message)}}}function g(){i.tagModal.classList.add("hidden"),i.newTagInput.value=""}function u(t){const e=new Date-t,n=Math.floor(e/6e4),a=Math.floor(e/36e5),i=Math.floor(e/864e5);return n<60?`${n} åˆ†é’Ÿå‰`:a<24?`${a} å°æ—¶å‰`:i<7?`${i} å¤©å‰`:t.toLocaleDateString("zh-CN")}function h(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function p(t){if(!t||0===t)return"";const e=Math.floor(t/3600),n=Math.floor(t%3600/60),a=Math.floor(t%60);return e>0?`${e}:${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`:`${n}:${a.toString().padStart(2,"0")}`}i.searchInput.addEventListener("input",t=>{d(t.target.value)}),i.tagFilter.addEventListener("change",()=>{d(i.searchInput.value)}),i.settingsBtn.addEventListener("click",()=>{chrome.tabs.create({url:"settings.html"})}),i.themeToggleBtn.addEventListener("click",async()=>{try{let t;"light"===((await chrome.storage.local.get(["theme"])).theme||"light")?(t="dark",i.themeToggleBtn.textContent="â˜€ï¸",i.themeToggleBtn.title="åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜"):(t="light",i.themeToggleBtn.textContent="ğŸŒ™",i.themeToggleBtn.title="åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜"),await chrome.storage.local.set({theme:t}),await applyTheme(t),showSuccess("ä¸»é¢˜å·²åˆ‡æ¢")}catch(t){console.error("åˆ‡æ¢ä¸»é¢˜å¤±è´¥:",t),showError("åˆ‡æ¢ä¸»é¢˜å¤±è´¥")}}),i.openOriginalBtn.addEventListener("click",()=>{e&&chrome.tabs.create({url:e.url})}),i.exportMarkdownBtn.addEventListener("click",()=>{e&&function(t){try{let e="";e+=`# ${t.title}\n\n`,e+=`**æ¥æº**: ${t.source}  \n`,e+=`**åŸæ–‡é“¾æ¥**: ${t.url}  \n`,e+=`**ä¿å­˜æ—¶é—´**: ${new Date(t.dateAdded).toLocaleString("zh-CN")}  \n`,t.tags&&t.tags.length>0&&(e+=`**æ ‡ç­¾**: ${t.tags.join(", ")}  \n`),e+="\n---\n\n",e+="## ğŸ“ AI æ‘˜è¦\n\n",e+=`${t.summary||"æš‚æ— æ‘˜è¦"}\n\n`,e+="## ğŸ’¡ æ ¸å¿ƒè§‚ç‚¹\n\n",t.keyPoints&&t.keyPoints.length>0?t.keyPoints.forEach((t,n)=>{e+=`${n+1}. ${t}\n`}):e+="æš‚æ— æ ¸å¿ƒè§‚ç‚¹\n",e+="\n---\n\n",e+="## ğŸ“„ åŸæ–‡å†…å®¹\n\n",e+=`${t.content||"å†…å®¹ä¸å¯ç”¨"}\n\n`,e+="\n---\n\n",e+="*æœ¬æ–‡ç”± Digest AI å¯¼å‡º*\n";const n=new Blob([e],{type:"text/markdown;charset=utf-8"}),a=URL.createObjectURL(n),i=document.createElement("a"),o=`${t.title.replace(/[<>:"/\\|?*]/g,"_")}.md`;i.href=a,i.download=o,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a),showSuccess("æ–‡ç« å·²å¯¼å‡ºä¸º Markdown")}catch(t){console.error("å¯¼å‡ºå¤±è´¥:",t),showError("å¯¼å‡ºå¤±è´¥: "+t.message)}}(e)}),i.deleteArticleBtn.addEventListener("click",async function(){if(!e)return;if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ"))return;const t=showLoading("æ­£åœ¨åˆ é™¤æ–‡ç« ...");try{await chrome.runtime.sendMessage({action:"deleteArticle",articleId:e.id}),t(),showSuccess("æ–‡ç« å·²åˆ é™¤"),await o()}catch(e){t(),console.error("åˆ é™¤æ–‡ç« å¤±è´¥:",e),showError("åˆ é™¤æ–‡ç« å¤±è´¥: "+e.message)}}),i.addTagBtn.addEventListener("click",function(){i.tagModal.classList.remove("hidden"),i.newTagInput.value="",i.newTagInput.focus()}),i.confirmTagBtn.addEventListener("click",()=>{m(i.newTagInput.value)}),i.cancelTagBtn.addEventListener("click",g),i.newTagInput.addEventListener("keypress",t=>{"Enter"===t.key&&m(t.target.value)}),i.articleTagsList.addEventListener("click",t=>{t.target.classList.contains("tag-remove")&&async function(t){if(!e)return;const n=(e.tags||[]).filter(e=>e!==t);try{await chrome.runtime.sendMessage({action:"updateArticleTags",articleId:e.id,tags:n}),e.tags=n,l(n),await o()}catch(t){console.error("åˆ é™¤æ ‡ç­¾å¤±è´¥:",t),alert("åˆ é™¤æ ‡ç­¾å¤±è´¥")}}(t.target.dataset.tag)}),i.tagModal.addEventListener("click",t=>{t.target===i.tagModal&&g()}),async function(){await o(),"dark"===((await chrome.storage.local.get(["theme"])).theme||"light")?(i.themeToggleBtn.textContent="â˜€ï¸",i.themeToggleBtn.title="åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜"):(i.themeToggleBtn.textContent="ğŸŒ™",i.themeToggleBtn.title="åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜")}()})();